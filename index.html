<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>eMigrant ‚Äî Miniapp MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0f1115;--card:#171a21;--text:#e7eaf0;--muted:#9aa3b2;--accent:#2a73ff;--line:#242936;--ok:#33d69e;--warn:#ffb84d;--danger:#ff6b6b}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 86px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:12px}
    h1,h2,h3{margin:0 0 10px} .small{color:var(--muted);font-size:13px}
    input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0c0f14;color:var(--text);margin-top:6px}
    button{cursor:pointer} button.primary{background:var(--accent);border-color:var(--accent)}
    .row{display:flex;gap:8px;align-items:center} .row> *{flex:1}
    .progress{height:10px;background:#0c0f14;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--accent)}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
    .ok{color:var(--ok);border-color:var(--ok)} .warn{color:var(--warn);border-color:var(--warn)}
    .bottom{position:fixed;left:0;right:0;bottom:0;background:#0c0f14;border-top:1px solid var(--line);display:flex;gap:6px;padding:8px}
    .bottom button{flex:1}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0f1115,rgba(15,17,21,0.6));backdrop-filter:blur(6px);z-index:2;border-bottom:1px solid var(--line);padding:12px}
    .hint{margin:8px 0 0}
    /* modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,0.5);z-index:10}
    .modal .sheet{width:min(720px,92vw);max-height:92vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .muted{color:var(--muted)} .center{text-align:center}
    .ghost{background:transparent}
    .danger{background:var(--danger);border-color:var(--danger)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
    .spinner{width:26px;height:26px;border:3px solid var(--line);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Timer styles */
    .timer-display{display:flex;justify-content:center;align-items:center;gap:16px;margin:20px 0}
    .timer-hours,.timer-minutes,.timer-seconds{font-size:42px;font-weight:bold;color:var(--accent);text-align:center;min-width:70px}
    .timer-label{font-size:12px;color:var(--muted);text-align:center;margin-top:4px}
    
    .status{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0c0f14}
    .status.ok{border-color:var(--ok)}
    .status.err{border-color:var(--danger)}
    
    /* Payment styles */
    .payment-details{margin:16px 0}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .payment-price{font-weight:bold;color:var(--accent)}
    .payment-price.total{font-size:18px;color:var(--ok)}
  </style>
</head>
<body>
<div class="wrap">
  <header><h2 id="title">eMigrant ¬∑ –û–Ω–±–æ—Ä–¥–∏–Ω–≥</h2></header>

  <!-- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (8 –≤–æ–ø—Ä–æ—Å–æ–≤) -->
  <div id="onb" class="card">
    <div class="badge">–®–∞–≥ <span id="step">1</span>/8</div>

    <!-- Q1 -->
    <div id="q1">
      <h3>1) –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?</h3>
      <label>–ò–º—è</label>
      <input id="firstName" placeholder="–ò–º—è"/>
      <label>–§–∞–º–∏–ª–∏—è</label>
      <input id="lastName" placeholder="–§–∞–º–∏–ª–∏—è"/>
      <div class="row" style="margin-top:10px">
        <span></span>
        <button class="primary" onclick="nextQValidated(1,2)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q2 -->
    <div id="q2" style="display:none">
      <h3>2) –ì–¥–µ —Ç—ã –∂–∏–≤—ë—à—å?</h3>
      <select id="voivodeship">
        <option value="Mazowieckie">Mazowieckie</option>
        <option value="Ma≈Çopolskie">Ma≈Çopolskie</option>
        <option value="Pomorskie">Pomorskie</option>
        <option value="Dolno≈õlƒÖskie">Dolno≈õlƒÖskie</option>
        <option value="Inne">Inne</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(1)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(2,3)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q3 -->
    <div id="q3" style="display:none">
      <h3>3) –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</h3>
      <select id="citizenship">
        <option value="UKR">–£–∫—Ä</option>
        <option value="BLR">–ë–µ–ª</option>
        <option value="RUS">–†—É—Å</option>
        <option value="Other">–î—Ä—É–≥–æ–µ</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(2)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(3,4)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q4 -->
    <div id="q4" style="display:none">
      <h3>4) –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—ã –≤ –ü–æ–ª—å—à–µ?</h3>
      <select id="stayLength">
        <option value="2-3">2‚Äì3 –≥–æ–¥–∞</option>
        <option value="<=1">–≥–æ–¥ –∏ –º–µ–Ω—å—à–µ</option>
        <option value=">=4">–±–æ–ª—å—à–µ 4 –ª–µ—Ç</option>
        <option value="new">—Ç–æ–ª—å–∫–æ –ø—Ä–∏–µ—Ö–∞–ª</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(3)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(4,5)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q5 -->
    <div id="q5" style="display:none">
      <h3>5) –¢–≤–æ–π —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h3>
      <select id="currentStatus">
        <option value="waiting">–ñ–¥—É</option>
        <option value="refused">–ü–æ–ª—É—á–∏–ª –æ—Ç–∫–∞–∑</option>
        <option value="statusUKR">Status UKR</option>
        <option value="pobytCzasowy">Pobyt Czasowy</option>
        <option value="other">Inne (Karta Polaka, Karta Rezydenta UE)</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(4)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(5,6)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q6 -->
    <div id="q6" style="display:none">
      <h3>6) –ö–∞–∫–∏–µ —É —Ç–µ–±—è –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è –í–ù–ñ?</h3>
      <div class="small">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
      <label><input type="checkbox" class="grounds" value="UoP"> –†–∞–±–æ—Ç–∞ (UoP)</label>
      <label><input type="checkbox" class="grounds" value="UoD"> –†–∞–±–æ—Ç–∞ (UoD)</label>
      <label><input type="checkbox" class="grounds" value="UoZ"> –†–∞–±–æ—Ç–∞ (UoZ)</label>
      <label><input type="checkbox" class="grounds" value="Dzialalnosc"> –†–∞–±–æ—Ç–∞ (Dzia≈Çalno≈õƒá)</label>
      <label><input type="checkbox" class="grounds" value="Study"> –£—á—ë–±–∞</label>
      <label><input type="checkbox" class="grounds" value="Family"> –°–µ–º—å—è</label>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(5)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(6,7)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q7 -->
    <div id="q7" style="display:none">
      <h3>7) –¢–≤–æ–π –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥ (brutto)</h3>
      <select id="income">
        <option value="<4700">–¥–æ 4700</option>
        <option value="4800-10000">4800‚Äì10000</option>
        <option value=">10000">10000+</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(6)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="nextQValidated(7,8)">–î–∞–ª–µ–µ</button>
      </div>
    </div>

    <!-- Q8 -->
    <div id="q8" style="display:none">
      <h3>8) –¢–≤–æ—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Ü–µ–ª—å –≤ –ü–æ–ª—å—à–µ</h3>
      <select id="goal">
        <option value="wait">–ü–µ—Ä–µ–∂–¥–∞—Ç—å –±—É—Ä—é</option>
        <option value="euResidentMaybe">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑–∏–¥–µ–Ω—Ç–∞, –Ω–æ –Ω–∞—Å—á—ë—Ç –ø–∞—Å–ø–æ—Ä—Ç–∞ –Ω–µ—É–≤–µ—Ä–µ–Ω</option>
        <option value="passport">–ü–æ–ª—É—á–∏—Ç—å –ø–∞—Å–ø–æ—Ä—Ç</option>
      </select>
      <div class="row" style="margin-top:10px">
        <button onclick="prevQ(7)">–ù–∞–∑–∞–¥</button>
        <button class="primary" onclick="finishOnb()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
      <div class="small" style="margin-top:8px">–ö–Ω–æ–ø–∫–∞ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–π–¥—ë—Ç –∫ —á–µ–∫–ª–∏—Å—Ç—É (PDF –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ).</div>
    </div>
  </div>

  <!-- –ß–µ–∫–ª–∏—Å—Ç -->
  <div id="home" style="display:none">
    <div class="card">
      <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
      <div class="progress"><span id="progressBar" style="width:0%"></span></div>
      <div class="small" style="margin-top:6px">–ì–æ—Ç–æ–≤–æ: <span id="doneCount">0</span>/<span id="totalCount">0</span></div>
      <div id="officeHint" class="small hint"></div>
    </div>

    <div id="tasks"></div>

    <!-- üîÑ –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ -->
    <div style="margin-top:16px; text-align:center">
      <button onclick="resetOnb()">üîÑ Reset (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)</button>
    </div>
  </div>
</div>

<!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
<div class="bottom">
  <button onclick="openChecklist()">Checklist</button>
  <button onclick="openModule('aiTranslator')">AI Translator</button>
  <button onclick="openModule('findSlot')">Book a slot</button>
  <button onclick="openModule('bookAssistant')">Start a chat</button>
</div>

<!-- ====== –ö–æ–Ω—Ç—Ä–∞–∫—Ç/–û—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Äî –º–æ–¥–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <button class="ghost" style="flex:0 0 auto;width:auto" onclick="closeModal()">‚Üê –ù–∞–∑–∞–¥</button>
      <div class="pill">–ö–æ–Ω—Ç—Ä–∞–∫—Ç / –û—Å–Ω–æ–≤–∞–Ω–∏–µ ¬∑ AI-–ø—Ä–æ–≤–µ—Ä–∫–∞</div>
      <span></span>
    </div>

    <!-- —ç–∫—Ä–∞–Ω 1: –∑–∞–≥—Ä—É–∑–∫–∞ -->
    <div id="ct_step1">
      <h3>–ó–∞–≥—Ä—É–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
      <div class="small">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è PDF, JPG, PNG (–¥–æ ~20 –ú–ë).</div>
      <input id="ct_file" type="file" accept=".pdf,.jpg,.jpeg,.png,.webp" />
      <div class="hr"></div>
      <button id="ct_btn_upload" class="primary" disabled onclick="ctStart()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å AI</button>
      <div class="small muted" style="margin-top:8px"><a href="javascript:void(0)" onclick="ctNoDoc()">–£ –º–µ–Ω—è –Ω–µ—Ç ‚Äî –ø–æ–º–æ–≥–∏—Ç–µ</a></div>
    </div>

    <!-- —ç–∫—Ä–∞–Ω 2: —Ç–∞–π–º–µ—Ä –Ω–∞ 24 —á–∞—Å–∞ -->
    <div id="ct_step2" style="display:none">
      <h3>AI –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω</h3>
      <div class="center">
        <div class="timer-display" id="ct_timer_display">
          <div class="timer-hours" id="ct_timer_hours">24</div>
          <div class="timer-label">—á–∞—Å–æ–≤</div>
        </div>
        <div class="timer-minutes" id="ct_timer_minutes">00</div>
        <div class="timer-label">–º–∏–Ω—É—Ç</div>
        <div class="timer-seconds" id="ct_timer_seconds">00</div>
        <div class="timer-label">—Å–µ–∫—É–Ω–¥</div>
      </div>
      <div class="status" id="ct_queue_msg" style="margin-top:16px">
        –¢–≤–æ–π –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ —á–µ—Ä–µ–∑ <span id="ct_time_remaining">24 —á–∞—Å–∞</span>. 
        –ú—ã –ø—Ä–∏—à–ª—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–¥–µ—Å—å.
      </div>
      <div class="small muted" style="margin-top:12px">
        –¢—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—à—å —É—Å–∫–æ—Ä–∏—Ç—å AI –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—ã—Å—Ç—Ä–µ–µ.
      </div>
      <div class="row" style="margin-top:16px">
        <button id="ct_btn_boost" class="primary" onclick="ctBoost()">–£—Å–∫–æ—Ä—è—é!</button>
      </div>
      <div class="small muted" id="ct_poll_note" style="margin-top:8px"></div>
    </div>

    <!-- —ç–∫—Ä–∞–Ω 3: –æ–ø–ª–∞—Ç–∞ -->
    <div id="ct_step3" style="display:none">
      <h3>–£—Å–∫–æ—Ä–µ–Ω–∏–µ AI –∞–Ω–∞–ª–∏–∑–∞</h3>
      <div class="status" style="margin-top:16px">
        <div class="center">
          <div style="font-size:24px;color:var(--accent);margin-bottom:8px">‚ö°</div>
          <div>–ü–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ 1 —á–∞—Å –≤–º–µ—Å—Ç–æ 24 —á–∞—Å–æ–≤</div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="payment-details">
        <div class="payment-item">
          <span>–£—Å–∫–æ—Ä–µ–Ω–∏–µ AI –∞–Ω–∞–ª–∏–∑–∞</span>
          <span class="payment-price">50 PLN</span>
        </div>
        <div class="payment-item">
          <span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</span>
          <span class="payment-price">+20 PLN</span>
        </div>
        <div class="hr"></div>
        <div class="payment-total">
          <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
          <span class="payment-price total">70 PLN</span>
        </div>
      </div>
      
      <div class="row" style="margin-top:20px">
        <button class="ghost" onclick="ctBackToTimer()">–û—Ç–º–µ–Ω–∞</button>
        <button class="primary" onclick="ctProcessPayment()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- —ç–∫—Ä–∞–Ω 4: —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div id="ct_step4" style="display:none">
      <h3 id="ct_result_title">–£—Ä–∞! –í—Å—ë —É–¥–∞–ª–æ—Å—å üéâ</h3>
      <div id="ct_result_box" class="status ok" style="margin-top:10px">
        <div id="ct_result_text">–í—Å–µ —á—ë—Ç–∫–æ. –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç.</div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="primary" onclick="ctBackToHome()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
        <button class="ghost" onclick="closeModal()">–û—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== Telegram init
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg && tg.ready(); tg && tg.expand(); } catch(e) {}

  // ====== –ü—Ä–æ—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const st = {
    track: localStorage.getItem('track') || null,
    tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
    profile: JSON.parse(localStorage.getItem('profile')||'{}')
  };

  // ====== –ö–æ–Ω—Ñ–∏–≥ AI-–º–æ–¥—É–ª—è
  const BACKEND_BASE = ""; // ‚Üê –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä/–±–æ—Ç API, —É–∫–∞–∂–∏—Ç–µ –±–∞–∑–æ–≤—ã–π URL
  const ENDPOINTS = BACKEND_BASE ? {
    upload: BACKEND_BASE + "/upload",
    analyze: BACKEND_BASE + "/analyze",
    status: BACKEND_BASE + "/status"
  } : null;

  const AI_PROMPT = `–ü—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–∫–æ–Ω—Ç—Ä–∞–∫—Ç/–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∞ –í–ù–ñ –≤ –ü–æ–ª—å—à–µ).
1) –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤: —Å—Ç–æ—Ä–æ–Ω—ã, NIP/PESEL (–µ—Å–ª–∏ –µ—Å—Ç—å), –∞–¥—Ä–µ—Å–∞, –¥–∞—Ç—ã, –ø–æ–¥–ø–∏—Å–∏, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è.
2) –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –§–ò–û —Å –∞–Ω–∫–µ—Ç–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—É—Å—Ç—ã–µ –ø–æ–ª—è, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã.
3) –†–∏—Å–∫–∏ –¥–ª—è –í–ù–ñ: –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –æ—Ç–∫–∞–∑ (–Ω–µ–ø–æ–ª–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å, –Ω–µ—Ç –∞–¥—Ä–µ—Å–∞, –Ω–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏—è).
4) –ò—Ç–æ–≥: –∫–æ—Ä–æ—Ç–∫–∏–π –≤–µ—Ä–¥–∏–∫—Ç (OK / –µ—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è) –∏ —á–µ–∫–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.
–í—ã–≤–æ–¥–∏ —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —Å –∫—Ä–∞—Ç–∫–∏–º–∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ä—É—Å—Å–∫–∏–π.`;

  // ====== –ë–∞–∑–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
  function baseTasks(track){
    const common = [
      {id:'wniosek', title:'Wniosek (PDF)', status:'todo', requiresAI:true, kind:'wniosek'},
      {id:'photos', title:'–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏', status:'todo', requiresAI:false, kind:'photos'},
      {id:'skarb', title:'Op≈Çata skarbowa', status:'todo', requiresAI:false, kind:'skarb'},
      {id:'rent', title:'Umowa najmu / Meldunek', status:'todo', requiresAI:true, kind:'rent'},
      {id:'ins', title:'Ubezpieczenie', status:'todo', requiresAI:true, kind:'insurance'},
      {id:'slot', title:'Find a slot', status:'todo', requiresAI:false, kind:'slot'},
      {id:'ai', title:'AI Translator', status:'todo', requiresAI:false, kind:'aiTranslator'},
      {id:'assist', title:'Book an assistant', status:'todo', requiresAI:false, kind:'bookAssistant'}
    ];
    if(track==='work'||track==='business'){
      common.splice(2,0,{id:'contract', title:'–ö–æ–Ω—Ç—Ä–∞–∫—Ç / –û—Å–Ω–æ–≤–∞–Ω–∏–µ', status:'todo', requiresAI:true, kind:'contract'});
      common.splice(3,0,{id:'hr', title:'Za≈ÇƒÖcznik od pracodawcy', status:'todo', requiresAI:true, kind:'attachmentHR'});
    }
    if(track==='study'){
      common.splice(2,0,{id:'uni', title:'–°–ø—Ä–∞–≤–∫–∞ –∏–∑ –≤—É–∑–∞', status:'todo', requiresAI:true, kind:'university'});
      common.splice(3,0,{id:'funds', title:'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö', status:'todo', requiresAI:true, kind:'funds'});
    }
    return common;
  }

  // ====== Voivodeship hint
  function officeHintByVoiv(v){
    const map = {
      'Mazowieckie': '–í–∞—à —É–∂–æ–Ω–¥: Mazowiecki. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª—è—Ä–∞–º: https://mazowieckie.example',
      'Ma≈Çopolskie': '–í–∞—à —É–∂–æ–Ω–¥: Ma≈Çopolski. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª—è—Ä–∞–º: https://malopolskie.example',
      'Pomorskie': '–í–∞—à —É–∂–æ–Ω–¥: Pomorski. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª—è—Ä–∞–º: https://pomorskie.example',
      'Dolno≈õlƒÖskie': '–í–∞—à —É–∂–æ–Ω–¥: Dolno≈õlƒÖski. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ñ–æ—Ä–º—É–ª—è—Ä–∞–º: https://dolnoslaskie.example',
      'Inne': '–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —É–∂–æ–Ω–¥–∞–º –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞: https://gov.example'
    };
    return map[v] || '';
  }

  // ====== Track detection
  function determineTrack(groundValues){
    const has = k => groundValues.includes(k);
    if (has('Study')) return 'study';
    if (has('Family')) return 'family';
    if (has('Dzialalnosc')) return 'business';
    if (has('UoP') || has('UoD') || has('UoZ')) return 'work';
    return 'work';
  }

  // ====== Checklist render
  function renderChecklist(){
    const title = st.profile?.trackLabel ? `eMigrant ¬∑ –ß–µ–∫–ª–∏—Å—Ç (${st.profile.trackLabel})` : 'eMigrant ¬∑ –ß–µ–∫–ª–∏—Å—Ç';
    document.getElementById('title').innerText = title;

    const tasksDiv = document.getElementById('tasks');
    tasksDiv.innerHTML = '';
    const done = st.tasks.filter(t=>t.status==='done').length;
    const total = st.tasks.length || 1;
    document.getElementById('doneCount').innerText = done;
    document.getElementById('totalCount').innerText = total;
    document.getElementById('progressBar').style.width = Math.round(done/total*100)+'%';
    document.getElementById('officeHint').innerText = st.profile?.voivodeship ? officeHintByVoiv(st.profile.voivodeship) : '';

    st.tasks.forEach(t=>{
      const card = document.createElement('div');
      card.className='card';
      const badgeClass = t.status==='done'?'ok':(t.status==='inreview'?'warn':'');
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <div style="flex:3">
            <h3 style="margin:0 0 6px">${t.title}</h3>
            <span class="badge ${badgeClass}">${t.status==='todo'?'To do':t.status==='inreview'?'In review':'Done'}</span>
            ${t.requiresAI?'<span class="small" style="margin-left:8px">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è AI-–ø—Ä–æ–≤–µ—Ä–∫–∞</span>':''}
          </div>
          <div style="flex:2">
            <div class="row">
              <button class="primary" onclick="openModule('${t.kind}')">–û—Ç–∫—Ä—ã—Ç—å</button>
              ${t.status!=='done'?'<button onclick="markDone(\''+t.id+'\')">–°–¥–µ–ª–∞–Ω–æ</button>':''}
            </div>
          </div>
        </div>
      `;
      tasksDiv.appendChild(card);
    });
  }

  function markDone(id){
    st.tasks = st.tasks.map(t=> t.id===id ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    renderChecklist();
  }

  // ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è
  function openChecklist(){
    document.getElementById('onb').style.display = 'none';
    document.getElementById('home').style.display = 'block';
    renderChecklist();
  }

  function openModule(kind){
    if(kind==='aiTranslator'){
      alert('AI Translator: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∏—Å—å–º–æ/–¥–æ–∫—É–º–µ–Ω—Ç ‚Üí –ø–µ—Ä–µ–≤–æ–¥ –∏ –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ. (–í MVP-–∑–∞–≥–ª—É—à–∫–µ –∑–∞–≥—Ä—É–∑–∫–∞ –æ–ø—É—â–µ–Ω–∞)');
      return;
    }
    if(kind==='findSlot'){
      const dates = prompt('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã/–¥–Ω–∏, –∫–æ–≥–¥–∞ –≤—ã –¥–æ—Å—Ç—É–ø–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–Ω/–°—Ä/–ü—Ç –∏–ª–∏ 20-25 –∞–≤–≥—É—Å—Ç–∞). –ú—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–º, –Ω–æ —Å–ª–æ—Ç –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω.');
      alert('–°–ø–∞—Å–∏–±–æ! –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞.\n–í–∞—à–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏: '+(dates||'–Ω–µ —É–∫–∞–∑–∞–Ω–æ')+'\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞ ‚Äî –≤—Ä—É—á–Ω—É—é.');
      return;
    }
    if(kind==='bookAssistant'){
      const text = prompt('–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ, –æ —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. –ó–∞—è–≤–∫–∞ —É–π–¥—ë—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç-–∞–∫–∫–∞—É–Ω—Ç.');
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –û–ö, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.');
      if(tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/'+(tg.initDataUnsafe?.user?.username||''));
      return;
    }
    if(kind==='photos'){
      alert('–§–æ—Ç–æ: –≥–∞–π–¥ –ø–æ —Ä–∞–∑–º–µ—Ä—É/—Ñ–æ–Ω—É. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ (AI-–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ MVP).');
      return;
    }
    if(kind==='insurance'){
      const has = confirm('–ï—Å—Ç—å –¥–µ–π—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞? (OK ‚Äî –¥–∞; –û—Ç–º–µ–Ω–∞ ‚Äî –Ω–µ—Ç)');
      if(!has){
        alert('–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç¬ª, —á—Ç–æ–±—ã –æ–±—Å—É–¥–∏—Ç—å, –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É.');
        if(tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/'+(tg.initDataUnsafe?.user?.username||'')); 
      } else {
        alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–ª–∏—Å. AI-–ø—Ä–æ–≤–µ—Ä–∫–∞: —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã.');
      }
      return;
    }
    if(kind==='wniosek'){
      const path = confirm('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Å–∫–∞–Ω –≤–Ω–µ—Å–∫–∞? (OK ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∞–Ω; –û—Ç–º–µ–Ω–∞ ‚Äî –ø—Ä–æ–π—Ç–∏ –∞–Ω–∫–µ—Ç—É –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF)');
      if(path){
        alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–∞–Ω. AI-–ø—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–¥–ø–∏—Å—å, –¥–∞—Ç—ã, —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –§–ò–û.');
      } else {
        alert('–û—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–Ω–∫–µ—Ç–∞ –≤–Ω–µ—Å–∫–∞ ‚Üí –∑–∞—Ç–µ–º –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å.');
      }
      return;
    }
    if(kind==='contract'){ openContractModal(); return; }
    if(kind==='attachmentHR'){
      alert('–°–∫–∞—á–∞–π—Ç–µ —à–∞–±–ª–æ–Ω, –æ—Ç–¥–∞–π—Ç–µ HR. –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π/—Å –ø–µ—á–∞—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç (AI-–ø—Ä–æ–≤–µ—Ä–∫–∞).');
      return;
    }
    if(kind==='rent'){
      alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã –∏–ª–∏ meldunek. AI-–ø—Ä–æ–≤–µ—Ä–∫–∞: –∞–¥—Ä–µ—Å, —Å—Ä–æ–∫–∏, –ø–æ–¥–ø–∏—Å–∏. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∂–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.');
      return;
    }
    if(kind==='university'){
      alert('–°–ø—Ä–∞–≤–∫–∞ –∏–∑ –≤—É–∑–∞: –ó–∞–≥—Ä—É–∑–∫–∞ ‚Üí AI-–ø—Ä–æ–≤–µ—Ä–∫–∞. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –≥–¥–µ –ø–æ–ª—É—á–∏—Ç—å.');
      return;
    }
    if(kind==='funds'){
      alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–¥—Å—Ç–≤–∞—Ö: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫—É—é —Å–ø—Ä–∞–≤–∫—É. AI-–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî —Å—É–º–º–∞/–¥–∞—Ç–∞/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã.');
      return;
    }
    if(kind==='skarb'){
      const paid = confirm('–û–ø–ª–∞—Ç–∏–ª–∏ –≥–æ—Å–ø–æ—à–ª–∏–Ω—É? (OK ‚Äî –¥–∞; –û—Ç–º–µ–Ω–∞ ‚Äî –Ω–µ—Ç)');
      if(paid){
        alert('–û—Ç–º–µ—Ç–∏–ª–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. (–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —á–µ–∫ ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ MVP)');
      } else {
        alert('–ü–æ–∫–∞–∂–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –∫–æ—Ä–æ—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –æ–ø–ª–∞—Ç–µ.');
      }
      return;
    }
  }

  // ====== –û–Ω–±–æ—Ä–¥–∏–Ω–≥
  function showQ(n){
    for(let i=1;i<=8;i++){ document.getElementById('q'+i).style.display = (i===n)?'':'none' }
    document.getElementById('step').innerText = String(n);
  }
  function prevQ(n){ showQ(n) }

  function isAnswered(step){
    switch(step){
      case 1:{
        const fn=document.getElementById('firstName'), ln=document.getElementById('lastName');
        if(!fn.value.trim()){fn.focus();alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ –∏–º—è.');return false;}
        if(!ln.value.trim()){ln.focus();alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ —Ñ–∞–º–∏–ª–∏—é.');return false;}
        return true;
      }
      case 2:{ const s=document.getElementById('voivodeship'); if(!s.value){s.focus();alert('–í—ã–±–µ—Ä–∏ –≤–æ–µ–≤–æ–¥—Å—Ç–≤–æ.'); return false;} return true; }
      case 3:{ const s=document.getElementById('citizenship'); if(!s.value){s.focus();alert('–í—ã–±–µ—Ä–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ.'); return false;} return true; }
      case 4:{ const s=document.getElementById('stayLength'); if(!s.value){s.focus();alert('–£–∫–∞–∂–∏ —Å—Ä–æ–∫ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è.'); return false;} return true; }
      case 5:{ const s=document.getElementById('currentStatus'); if(!s.value){s.focus();alert('–í—ã–±–µ—Ä–∏ —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å.'); return false;} return true; }
      case 6:{ const any=Array.from(document.querySelectorAll('.grounds')).some(el=>el.checked); if(!any){alert('–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ.'); return false;} return true; }
      case 7:{ const s=document.getElementById('income'); if(!s.value){s.focus();alert('–£–∫–∞–∂–∏ –¥–æ—Ö–æ–¥.'); return false;} return true; }
      case 8:{ const s=document.getElementById('goal'); if(!s.value){s.focus();alert('–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å.'); return false;} return true; }
      default:return true;
    }
  }
  function nextQValidated(curr,next){ if(isAnswered(curr)){ showQ(next); } }

  function finishOnb(){
    for(let i=1;i<=8;i++){ if(!isAnswered(i)){ showQ(i); return; } }

    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const voivodeship = document.getElementById('voivodeship').value;
    const citizenship = document.getElementById('citizenship').value;
    const stayLength = document.getElementById('stayLength').value;
    const currentStatus = document.getElementById('currentStatus').value;
    const income = document.getElementById('income').value;
    const goal = document.getElementById('goal').value;
    const grounds = Array.from(document.querySelectorAll('.grounds')).filter(el=>el.checked).map(el=>el.value);

    const track = determineTrack(grounds);
    const trackLabel = track==='work'?'–†–∞–±–æ—Ç–∞':track==='study'?'–£—á—ë–±–∞':track==='family'?'–°–µ–º—å—è':'–ë–∏–∑–Ω–µ—Å';

    st.profile = { firstName, lastName, voivodeship, citizenship, stayLength, currentStatus, grounds, income, goal, track, trackLabel };
    localStorage.setItem('profile', JSON.stringify(st.profile));

    st.track = track;
    st.tasks = baseTasks(track);
    localStorage.setItem('track', track);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));

    document.getElementById('onb').style.display='none';
    document.getElementById('home').style.display='';
    renderChecklist();
  }

  // ====== Reset (—Ç–µ—Å—Ç—ã)
  function resetOnb(){
    if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –∞–Ω–∫–µ—Ç—É –∏ –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞?")){
      localStorage.removeItem('track');
      localStorage.removeItem('tasks');
      localStorage.removeItem('profile');
      st.track = null; st.tasks=[]; st.profile={};
      document.getElementById('home').style.display='none';
      document.getElementById('onb').style.display='';
      showQ(1);
    }
  }

  // ====== –ö–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ª–æ–≥–∏–∫–∞
  let ct = { file: null, fileMeta: null, jobId: null, pollTimer: null, boosted:false };

  function el(id){ return document.getElementById(id); }
  function openContractModal(){
    ct = { file:null, fileMeta:null, jobId:null, pollTimer:null, boosted:false };
    el('modal').style.display='grid';
    el('ct_step1').style.display='';
    el('ct_step2').style.display='none';
    el('ct_step3').style.display='none';
    el('ct_btn_upload').disabled = true;
    el('ct_file').value = '';
  }
  function closeModal(){
    el('modal').style.display='none';
    if(ct.pollTimer){ clearInterval(ct.pollTimer); ct.pollTimer=null; }
  }
  function ctBackToHome(){ closeModal(); openChecklist(); }

  // enable button when file chosen
  el('ct_file').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    ct.file = f || null;
    el('ct_btn_upload').disabled = !ct.file;
  });

  function ctNoDoc(){
    alert('–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ —á–∞—Ç ‚Äî –ø–æ–º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç/—à–∞–±–ª–æ–Ω.');
    if(tg && tg.openTelegramLink){ tg.openTelegramLink('https://t.me/'+(tg.initDataUnsafe?.user?.username||'')); }
  }

  async function ctStart(){
    if(!ct.file){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.'); return; }
    el('ct_step1').style.display='none';
    el('ct_step2').style.display='';
    el('ct_step3').style.display='none';
    el('ct_step4').style.display='none';
    el('ct_poll_note').innerText = '';

    try{
      // 1) –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
      let uploadRes = null;
      if(ENDPOINTS){
        const fd = new FormData();
        fd.append('file', ct.file);
        fd.append('source', 'emigrant_webapp');
        const resp = await fetch(ENDPOINTS.upload, { method:'POST', body: fd });
        if(!resp.ok) throw new Error('Upload failed');
        uploadRes = await resp.json(); // –æ–∂–∏–¥–∞–µ–º {file_id, file_url, name, size}
      } else {
        // fallback: —à–ª—ë–º –±–æ—Ç—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –ø—É—Å—Ç—å –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤ —á–∞—Ç–µ
        uploadRes = { file_id: null, file_url: null, name: ct.file.name, size: ct.file.size };
      }

      ct.fileMeta = uploadRes;

      // 2) –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
      let analyzeRes = null;
      if(ENDPOINTS){
        const body = { file_id: uploadRes.file_id, file_url: uploadRes.file_url, prompt: AI_PROMPT, priority: ct.boosted?'high':'normal' };
        const resp = await fetch(ENDPOINTS.analyze, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!resp.ok) throw new Error('Analyze start failed');
        analyzeRes = await resp.json(); // –æ–∂–∏–¥–∞–µ–º {job_id}
        ct.jobId = analyzeRes.job_id;
        startPolling();
      } else {
        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç web_app_data
        try{
          tg && tg.sendData && tg.sendData(JSON.stringify({
            type:'analyze_contract',
            prompt: AI_PROMPT,
            fileMeta: { name: ct.file.name, size: ct.file.size },
            note:'–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ backend ENDPOINTS ‚Äî –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ sendData'
          }));
          // –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º fakeFinishOk() —Å—Ä–∞–∑—É - –∂–¥–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 24 —á–∞—Å–∞
        }catch(e){}
      }

    }catch(err){
      console.error(err);
      el('ct_queue_msg').innerText = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
      el('ct_btn_boost').disabled = true;
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –Ω–∞ 24 —á–∞—Å–∞
  function startContractTimer(){
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 24 —á–∞—Å–∞
    const endTime = new Date().getTime() + (24 * 60 * 60 * 1000);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ localStorage
    localStorage.setItem('contractTimerEnd', endTime.toString());
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    if(ct.timerInterval) clearInterval(ct.timerInterval);
    ct.timerInterval = setInterval(() => {
      updateContractTimer(endTime);
    }, 1000);
    
    // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
    updateContractTimer(endTime);
    
    console.log('–¢–∞–π–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∑–∞–ø—É—â–µ–Ω, –æ–∫–æ–Ω—á–∞–Ω–∏–µ:', new Date(endTime).toLocaleString());
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
  function updateContractTimer(endTime){
    const now = new Date().getTime();
    const timeLeft = endTime - now;
    
    if(timeLeft <= 0){
      // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      clearInterval(ct.timerInterval);
      ct.timerInterval = null;
      
      console.log('–¢–∞–π–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏—Å—Ç–µ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
      
      // –ï—Å–ª–∏ –Ω–µ—Ç backend, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      if(!ENDPOINTS){
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ–¥—Ö–æ–¥–∏—Ç/–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç)
        const isDocumentOk = Math.random() > 0.3; // 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç
        
        if(isDocumentOk){
          // –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
          showSuccessResult();
        } else {
          // –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
          showRedFlagsResult();
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      el('ct_timer_hours').innerText = '00';
      el('ct_timer_minutes').innerText = '00';
      el('ct_timer_seconds').innerText = '00';
      el('ct_time_remaining').innerText = '0 –º–∏–Ω—É—Ç';
      el('ct_queue_msg').innerText = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤.';
      return;
    }
    
    // –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    el('ct_timer_hours').innerText = hours.toString().padStart(2, '0');
    el('ct_timer_minutes').innerText = minutes.toString().padStart(2, '0');
    el('ct_timer_seconds').innerText = seconds.toString().padStart(2, '0');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    if(hours > 0){
      el('ct_time_remaining').innerText = `${hours} —á–∞—Å${hours === 1 ? '' : hours < 5 ? '–∞' : '–æ–≤'} ${minutes} –º–∏–Ω—É—Ç`;
    } else {
      el('ct_time_remaining').innerText = `${minutes} –º–∏–Ω—É—Ç`;
    }
  }

  function ctBoost(){
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
    el('ct_step2').style.display='none';
    el('ct_step3').style.display='';
    }
  
  // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Ç–∞–π–º–µ—Ä—É
  function ctBackToTimer(){
    el('ct_step3').style.display='none';
    el('ct_step2').style.display='';
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã
  function ctProcessPayment(){
    // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã
    el('ct_poll_note').innerText = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É...';
    
    setTimeout(() => {
      // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      ct.boosted = true;
      
      // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
      if(ct.timerInterval){
        clearInterval(ct.timerInterval);
        ct.timerInterval = null;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
      el('ct_step3').style.display='none';
      el('ct_step4').style.display='';
      
      // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      el('ct_result_title').innerText = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç...';
      el('ct_result_box').innerHTML = '<div class="spinner"></div><div style="margin-top:10px">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç...</div>';
      
      // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      setTimeout(() => {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ–¥—Ö–æ–¥–∏—Ç/–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç)
        const isDocumentOk = Math.random() > 0.3; // 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç
        
        if(isDocumentOk){
          // –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
          showSuccessResult();
        } else {
          // –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
          showRedFlagsResult();
        }
      }, 3000);
      
    }, 2000);
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  function showSuccessResult(){
    el('ct_result_title').innerText = '–£—Ä–∞! –í—Å—ë —É–¥–∞–ª–æ—Å—å üéâ';
    el('ct_result_box').className = 'status ok';
    el('ct_result_box').innerHTML = '<div>–í—Å–µ —á—ë—Ç–∫–æ. –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç.</div>';
    
    // –ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
  function showRedFlagsResult(){
    el('ct_result_title').innerText = '–ú—ã –∑–∞–º–µ—Ç–∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –≤ —Ç–≤–æ–µ–π —É–º–æ–≤–µ';
    el('ct_result_box').className = 'status err';
    el('ct_result_box').innerHTML = `
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:24px;margin-bottom:8px">‚ö†Ô∏è</div>
        <div>–£–∑–Ω–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –∏–ª–∏ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π –Ω–∞—à–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏</div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showDetailedReport()" style="width:100%;margin-bottom:8px">
          –£–∑–Ω–∞—Ç—å —á—Ç–æ –Ω–µ —Ç–∞–∫
        </button>
        <button class="ghost" onclick="ignoreRedFlags()" style="width:100%">
          –ü—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        </button>
      </div>
    `;
    
    // –ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ —Ç—Ä–µ–±—É—é—â—É—é –≤–Ω–∏–º–∞–Ω–∏—è
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'inreview'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
  function showDetailedReport(){
    el('ct_result_box').innerHTML = `
      <div style="margin-bottom:16px">
        <h4>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É:</h4>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>–ü—Ä–æ–±–ª–µ–º–∞ 1:</strong> –ù–µ–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ
        </div>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>–ü—Ä–æ–±–ª–µ–º–∞ 2:</strong> –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª–Ω—É—é –∑–∞–Ω—è—Ç–æ—Å—Ç—å
        </div>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>–ü—Ä–æ–±–ª–µ–º–∞ 3:</strong> –ù–µ —É–∫–∞–∑–∞–Ω —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞
        </div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showRedFlagsResult()" style="width:100%">
          –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        </button>
      </div>
    `;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–∞—Å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
  function ignoreRedFlags(){
    el('ct_result_box').innerHTML = `
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:24px;margin-bottom:8px">ü§∑</div>
        <div>–í—ã —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">
          –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è, –Ω–æ –º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
        </div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showRedFlagsResult()" style="width:100%">
          –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        </button>
      </div>
    `;
    
    // –ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é (–Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã)
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
  }
  
  function startPolling(){
    if(!ct.jobId){ return; }
    if(ct.pollTimer){ clearInterval(ct.pollTimer); }
    ct.pollTimer = setInterval(async ()=>{
      try{
        const url = ENDPOINTS.status + '?id=' + encodeURIComponent(ct.jobId);
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('status failed');
        const data = await resp.json(); // –æ–∂–∏–¥–∞–µ–º {status:'queued|running|succeeded|failed', result?:{ok:boolean, issues?:[] , message?:string}}
        if(data.status==='queued' || data.status==='running'){
          el('ct_poll_note').innerText = data.status==='running' ? 'AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç‚Ä¶' : '–í –æ—á–µ—Ä–µ–¥–∏‚Ä¶';
          return;
        }
        clearInterval(ct.pollTimer); ct.pollTimer=null;
        showResultScreen(data);
      }catch(e){
        console.error(e);
        clearInterval(ct.pollTimer); ct.pollTimer=null;
        showResultScreen({status:'failed', result:{ ok:false, message:'–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.' }});
      }
    }, 2500);
  }

  function showResultScreen(data){
    el('ct_step2').style.display='none';
    el('ct_step4').style.display='';
    const ok = data.status==='succeeded' && data.result?.ok!==false;
    el('ct_result_title').innerText = ok ? '–£—Ä–∞! –í—Å—ë —É–¥–∞–ª–æ—Å—å üéâ' : '–ù–∞–π–¥–µ–Ω—ã –∑–∞–º–µ—á–∞–Ω–∏—è';
    el('ct_result_box').className = 'status ' + (ok?'ok':'err');

    if(ok){
      el('ct_result_text').innerText = data.result?.message || '–í—Å–µ —á—ë—Ç–∫–æ. –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç.';
      // –º–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ "inreview" –∏–ª–∏ "done"
      st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
    }else{
      const issues = data.result?.issues || [];
      const text = (data.result?.message || '–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã:') + '\n' +
        (issues.length? issues.map((x,i)=>`${i+1}) ${x}`).join('\n') : '');
      el('ct_result_text').innerText = text.trim();
      st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'inreview'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
    }
  }

  // –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–µ–∑ backend
  function fakeFinishOk(){
    setTimeout(()=>{
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø–æ–¥—Ö–æ–¥–∏—Ç/–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç)
      const isDocumentOk = Math.random() > 0.3; // 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç
      
      if(isDocumentOk){
        // –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
        showSuccessResult();
      } else {
        // –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
        showRedFlagsResult();
      }
    }, 2000);
  }

  // ====== –ú–æ–¥–∞–ª–∫–∞ ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
  function closeOnBackdrop(e){ if(e.target.id==='modal') closeModal(); }
  document.getElementById('modal').addEventListener('click', closeOnBackdrop);
  document.getElementById('ct_btn_upload').disabled = true; // init

  // ====== –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
  (function init(){
    if(st.track){
      document.getElementById('onb').style.display='none';
      document.getElementById('home').style.display='';
      renderChecklist();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
      const contractTimerEnd = localStorage.getItem('contractTimerEnd');
      if(contractTimerEnd){
        const endTime = parseInt(contractTimerEnd);
        const now = new Date().getTime();
        if(endTime > now){
          // –¢–∞–π–º–µ—Ä –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
          if(ct.timerInterval) clearInterval(ct.timerInterval);
          ct.timerInterval = setInterval(() => {
            updateContractTimer(endTime);
          }, 1000);
          updateContractTimer(endTime);
        } else {
          // –¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫ - –æ—á–∏—â–∞–µ–º
          localStorage.removeItem('contractTimerEnd');
        }
      }
    } else {
      showQ(1);
    }
  })();
</script>
</body>
</html>
