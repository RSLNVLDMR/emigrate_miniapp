<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>eMigrant — Miniapp MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#2563eb" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#1e293b;
      --muted:#64748b;
      --accent:#2563eb;
      --accent-light:#3b82f6;
      --line:#e2e8f0;
      --ok:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px -1px rgba(0,0,0,0.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -4px rgba(0,0,0,0.1);
    }
    
    *{box-sizing:border-box} 
    html,body{height:100%}
    
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.6 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      /* Telegram Mini App optimizations */
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      overflow-x: hidden;
    }
    
    .wrap{max-width:100%;margin:0 auto;padding:16px 16px 80px;padding-top:16px}
    
    /* Когда хедер скрыт, убираем отступ сверху */
    .wrap.no-header{padding-top:16px}
    
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      margin-bottom:12px;
      box-shadow:var(--shadow);
      transition:all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      transform:translateY(0);
      opacity:1;
    }
    
    .card:hover{
      box-shadow:var(--shadow-lg);
      transform:translateY(-4px);
    }
    
    .card.animate-in{
      animation:slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    .card.animate-out{
      animation:slideOutDown 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    h1,h2,h3{
      margin:0 0 16px;
      font-weight:700;
      line-height:1.2;
    }
    
    h1{font-size:24px}
    h2{font-size:20px}
    h3{font-size:18px}
    
    header h2{
      margin:0;
      font-size:18px;
    }
    
    .small{color:var(--muted);font-size:14px;line-height:1.5}
    
    input,select,button,textarea{
      width:100%;
      padding:14px 16px;
      border-radius:12px;
      border:2px solid var(--line);
      background:var(--card);
      color:var(--text);
      margin-top:8px;
      font-size:16px;
      transition:all 0.2s ease;
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
    }
    
    input:focus,select:focus,button:focus,textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,0.1);
    }
    
    button{
      cursor:pointer;
      font-weight:600;
      transition:all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position:relative;
      overflow:hidden;
    }
    
    button::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
      transition:left 0.5s;
    }
    
    button:hover::before{
      left:100%;
    }
    
    button.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-light));
      border-color:var(--accent);
      color:white;
      box-shadow:0 4px 16px 0 rgba(37,99,235,0.2);
      min-height:52px;
      font-weight:600;
      font-size:16px;
      letter-spacing:0.3px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      /* Telegram Mini App button optimizations */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    button.primary:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 25px 0 rgba(37,99,235,0.4);
      background:linear-gradient(135deg,var(--accent-light),var(--accent));
    }
    
    button.primary:active{
      transform:translateY(0);
      box-shadow:0 2px 8px 0 rgba(37,99,235,0.25);
    }
    
    button.ghost{
      background:transparent;
      border-color:var(--line);
      color:var(--text);
    }
    
    button.ghost:hover{
      background:var(--bg);
      border-color:var(--accent);
      transform:translateY(-1px);
    }
    
    button.ghost:active{
      transform:translateY(0);
    }
    
    .row{display:flex;gap:12px;align-items:center} 
    .row> *{flex:1}
    
    .progress{
      height:12px;
      background:var(--line);
      border-radius:999px;
      overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent-light));
      border-radius:999px;
      transition:width 0.3s ease;
    }
    
    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--line);
      color:var(--muted);
      background:var(--card);
    }
    
    .ok{color:var(--ok);border-color:var(--ok);background:rgba(16,185,129,0.1)}
    .warn{color:var(--warn);border-color:var(--warn);background:rgba(245,158,11,0.1)}
    
    #income_warning {
      border-left: 4px solid var(--warn);
      animation: pulse 2s infinite;
    }
    
    #income_warning .status {
      margin: 0;
    }
    
    .help-link{
      color:var(--accent);
      text-decoration:none;
      padding:8px 16px;
      border-radius:20px;
      background:rgba(37,99,235,0.08);
      border:1px solid rgba(37,99,235,0.15);
      transition:all 0.2s ease;
      display:inline-block;
    }
    
    .help-link:hover{
      background:rgba(37,99,235,0.12);
      border-color:rgba(37,99,235,0.25);
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(37,99,235,0.15);
    }
    
    button:disabled{
      opacity:0.4;
      cursor:not-allowed;
      transform:none !important;
    }
    
    button.primary:disabled{
      background:linear-gradient(135deg,#94a3b8,#cbd5e1);
      border-color:#94a3b8;
      color:#475569;
      box-shadow:0 2px 8px 0 rgba(148,163,184,0.2) !important;
    }
    
    .bottom{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:rgba(255,255,255,0.98);
      backdrop-filter:blur(20px);
      border-top:1px solid var(--line);
      display:flex;
      gap:6px;
      padding:12px 16px;
      box-shadow:0 -2px 16px rgba(0,0,0,0.1);
      z-index:100;
      /* Telegram Mini App bottom menu optimizations */
      -webkit-backdrop-filter:blur(20px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    
    .bottom button{
      flex:1;
      border-radius:12px;
      padding:12px 8px;
      font-weight:600;
      font-size:13px;
      background:var(--card);
      border:1px solid var(--line);
      color:var(--text);
      transition:all 0.2s ease;
      min-height:44px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      /* Telegram Mini App button optimizations */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .bottom button:hover{
      background:var(--accent);
      color:white;
      border-color:var(--accent);
      transform:translateY(-1px);
    }
    
    header{
      position:sticky;
      top:0;
      background:rgba(255,255,255,0.98);
      backdrop-filter:blur(20px);
      z-index:50;
      border-bottom:1px solid var(--line);
      padding:16px;
      box-shadow:0 1px 12px rgba(0,0,0,0.05);
      height:60px;
      box-sizing:border-box;
      display:none;
      align-items:center;
    }
    
    .hint{margin:12px 0 0;color:var(--muted)}
    
    /* modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background:rgba(0,0,0,0.4);
      z-index:10;
      backdrop-filter:blur(4px);
      opacity:0;
      transition:opacity 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .modal.show{
      opacity:1;
    }
    
    .modal .sheet{
      width:min(100%,calc(100vw - 32px));
      max-height:calc(100vh - 32px);
      overflow:auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      padding:20px;
      box-shadow:var(--shadow-lg);
      transform:scale(0.95) translateY(20px);
      opacity:0;
      transition:all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      /* Telegram Mini App modal optimizations */
      -webkit-overflow-scrolling: touch;
    }
    
    .modal.show .sheet{
      transform:scale(1) translateY(0);
      opacity:1;
    }
    
    .muted{color:var(--muted)} 
    .center{text-align:center}
    
    .danger{background:var(--danger);border-color:var(--danger);color:white}
    
    .hr{height:1px;background:var(--line);margin:16px 0}
    

    
    .spinner{
      width:32px;
      height:32px;
      border:3px solid var(--line);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:16px auto;
    }
    
    @keyframes spin{to{transform:rotate(360deg)}}
    
    @keyframes slideInUp{
      from{
        opacity:0;
        transform:translateY(30px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    
    @keyframes slideOutDown{
      from{
        opacity:1;
        transform:translateY(0);
      }
      to{
        opacity:0;
        transform:translateY(30px);
      }
    }
    
    @keyframes pulse{
      0%, 100%{
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(37,99,235,0.1);
      }
      50%{
        transform:scale(1.02);
        box-shadow:0 0 0 10px rgba(37,99,235,0.1);
      }
    }
    

    
    @keyframes fadeIn{
      from{
        opacity:0;
        transform:translateY(10px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    
    @keyframes slideInRight{
      from{
        opacity:0;
        transform:translateX(30px);
      }
      to{
        opacity:1;
        transform:translateX(0);
      }
    }
    

    
    .status{
      padding:16px;
      border-radius:16px;
      border:1px solid var(--line);
      background:var(--bg);
      box-shadow:var(--shadow);
    }
    
    .completion-info{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      box-shadow:var(--shadow);
    }
    
    .status.ok{
      border-color:var(--ok);
      background:rgba(16,185,129,0.05);
    }
    
    .status.err{
      border-color:var(--danger);
      background:rgba(239,68,68,0.05);
    }
    
    /* Payment styles */
    .payment-details{margin:20px 0}
    .payment-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid var(--line);
    }
    
    .payment-item:last-child{border-bottom:none}
    
    .payment-price{font-weight:700;color:var(--accent);font-size:15px}
    .payment-price.total{font-size:18px;color:var(--ok)}
    
    /* Photo module styles */
    .photo-requirements{margin:16px 0}
    .requirement-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid var(--line);
    }
    
    .requirement-item:last-child{border-bottom:none}
    
    .requirement-value{
      font-weight:700;
      color:var(--accent);
      font-size:15px;
    }
    
    .photo-studios{margin:16px 0}
    .studio-item{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:10px;
      box-shadow:var(--shadow);
      transition:all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      transform:translateY(0);
      opacity:1;
    }
    
    .studio-item:hover{
      box-shadow:var(--shadow-lg);
      transform:translateY(-2px);
    }
    
    .studio-item:nth-child(1){animation:fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.1s both}
    .studio-item:nth-child(2){animation:fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s both}
    .studio-item:nth-child(3){animation:fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s both}
    
    .studio-info h4{
      margin:0 0 8px;
      color:var(--text);
      font-size:15px;
      font-weight:700;
    }
    
    .studio-details{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-bottom:10px;
    }
    
    .studio-details span{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:4px;
    }
    
    .studio-actions{
      display:flex;
      gap:6px;
    }
    
    .studio-actions button{
      flex:1;
      padding:8px 10px;
      border-radius:10px;
      font-weight:600;
      font-size:13px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 480px) {
      .wrap {
        padding: 16px 12px 80px;
      }
      
      .wrap.no-header {
        padding: 12px 12px 80px;
      }
      
      .card {
        padding: 16px;
        margin-bottom: 10px;
        border-radius: 14px;
      }
      
      h1 { font-size: 22px; }
      h2 { font-size: 18px; }
      h3 { font-size: 16px; }
      
      header {
        height: 56px;
        padding: 12px;
        display: none;
      }
      
      header h2 {
        margin: 0;
        font-size: 16px;
      }
      
      input, select, button, textarea {
        padding: 12px 14px;
        border-radius: 10px;
        font-size: 16px;
      }
      

      
      .status {
        padding: 14px;
        border-radius: 14px;
      }
      
      .photo-studios {
        margin: 12px 0;
      }
      
      .studio-item {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 12px;
      }
      
      .studio-info h4 {
        font-size: 14px;
        margin: 0 0 6px;
      }
      
      .studio-details {
        gap: 2px;
        margin-bottom: 8px;
      }
      
      .studio-details span {
        font-size: 11px;
      }
      
      .studio-actions button {
        padding: 8px;
        font-size: 12px;
        border-radius: 8px;
      }
      
      .photo-requirements {
        margin: 12px 0;
      }
      
      .requirement-item {
        padding: 6px 0;
      }
      
      .bottom {
        padding: 8px 12px;
      }
      
      .bottom button {
        min-height: 40px;
        font-size: 12px;
        padding: 8px 6px;
      }
    }
    
    /* Extra small screens optimization */
    @media (max-width: 375px) {
      .studio-item {
        padding: 10px;
        margin-bottom: 6px;
      }
      
      .studio-info h4 {
        font-size: 13px;
      }
      
      .studio-details span {
        font-size: 10px;
      }
      
      .studio-actions button {
        padding: 6px 8px;
        font-size: 11px;
      }
      
      .photo-requirements {
        margin: 8px 0;
      }
      
      .requirement-item {
        padding: 4px 0;
      }
      
      .modal .sheet {
        width: calc(100vw - 24px);
        max-height: calc(100vh - 24px);
        padding: 16px;
        border-radius: 16px;
      }
      
      .bottom {
        padding: 10px 12px;
        gap: 4px;
      }
      
      .bottom button {
        padding: 10px 6px;
        font-size: 12px;
        min-height: 40px;
      }
      
      .row {
        gap: 8px;
      }
      
      .payment-item, .requirement-item {
        padding: 8px 0;
      }
      
      .studio-item {
        padding: 14px;
        margin-bottom: 10px;
        border-radius: 14px;
      }
      
      .studio-actions {
        gap: 6px;
      }
      
      .studio-actions button {
        padding: 8px;
        font-size: 13px;
      }
      
      .custom-checkbox {
        padding: 10px;
        gap: 10px;
        border-radius: 10px;
        margin-bottom: 6px;
      }
      
      .custom-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      
      .custom-checkbox-text {
        font-size: 15px;
      }
    }
    
    /* Custom checkbox styles */
    .custom-checkbox {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 2px solid var(--line);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--card);
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      /* Ensure the entire area is clickable */
      min-height: 44px;
      /* Prevent text selection */
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .custom-checkbox:hover {
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.02);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    .custom-checkbox.checked {
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.08);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    }
    
    .custom-checkbox:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(37, 99, 235, 0.1);
    }
    
    .custom-checkbox:focus-within {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    .custom-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      appearance: none;
      border: 2px solid var(--line);
      border-radius: 4px;
      background: var(--card);
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      /* Ensure checkbox doesn't interfere with label clicks */
      pointer-events: none;
      /* Make it visually integrated */
      flex-shrink: 0;
    }
    
    .custom-checkbox input[type="checkbox"]:checked {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .custom-checkbox input[type="checkbox"]:checked::before {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    
    .custom-checkbox-text {
      flex: 1;
      font-size: 16px;
      color: var(--text);
    }
    
    .custom-checkbox.checked .custom-checkbox-text {
      color: var(--accent);
      font-weight: 600;
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      button {
        min-height: 44px;
      }
      
      .custom-checkbox {
        min-height: 48px;
        padding: 14px;
      }
      
      .custom-checkbox:active {
        transform: scale(0.98);
        background: rgba(37, 99, 235, 0.12);
      }
      
      .card:hover {
        transform: none;
      }
      
      .studio-item:hover {
        transform: none;
      }
      
      button.primary:hover {
        transform: none;
      }
      
      button.ghost:hover {
        transform: none;
      }
      
      .custom-checkbox:hover {
        border-color: var(--line);
        background: var(--card);
        transform: none;
        box-shadow: none;
      }
      
      .custom-checkbox:active {
        transform: none;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header><h2 id="title">eMigrant · Онбординг</h2></header>

  <!-- Онбординг (8 вопросов) -->
  <div id="onb" class="card">
    <div class="badge">Шаг <span id="step">1</span>/8</div>

    <!-- Q1 -->
    <div id="q1">
      <h3>1) Имя и фамилия</h3>
      <label>Имя</label>
      <input id="firstName" placeholder="Имя" autocomplete="given-name"/>
      <label>Фамилия</label>
      <input id="lastName" placeholder="Фамилия" autocomplete="family-name"/>
      <div class="row" style="margin-top:16px">
        <span></span>
        <button class="primary" onclick="nextQValidated(1,2)">Далее</button>
      </div>
    </div>

    <!-- Q2 -->
    <div id="q2" style="display:none">
      <h3>2) Место жительства</h3>
      <select id="voivodeship">
        <option value="Mazowieckie">Mazowieckie</option>
        <option value="Małopolskie">Małopolskie</option>
        <option value="Pomorskie">Pomorskie</option>
        <option value="Dolnośląskie">Dolnośląskie</option>
        <option value="Kujawsko-Pomorskie">Kujawsko-Pomorskie</option>
        <option value="Lubelskie">Lubelskie</option>
        <option value="Lubuskie">Lubuskie</option>
        <option value="Łódzkie">Łódzkie</option>
        <option value="Opolskie">Opolskie</option>
        <option value="Podkarpackie">Podkarpackie</option>
        <option value="Podlaskie">Podlaskie</option>
        <option value="Śląskie">Śląskie</option>
        <option value="Świętokrzyskie">Świętokrzyskie</option>
        <option value="Warmińsko-Mazurskie">Warmińsko-Mazurskie</option>
        <option value="Wielkopolskie">Wielkopolskie</option>
        <option value="Zachodniopomorskie">Zachodniopomorskie</option>
        <option value="Inne">Inne</option>
      </select>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(1)">Назад</button>
        <button class="primary" onclick="nextQValidated(2,3)">Далее</button>
      </div>
    </div>

    <!-- Q3 -->
    <div id="q3" style="display:none">
      <h3>3) Гражданство</h3>
      <select id="citizenship">
        <option value="UKR">Укр</option>
        <option value="BLR">Бел</option>
        <option value="RUS">Рус</option>
        <option value="Other">Другое</option>
      </select>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(2)">Назад</button>
        <button class="primary" onclick="nextQValidated(3,4)">Далее</button>
      </div>
    </div>

    <!-- Q4 -->
    <div id="q4" style="display:none">
      <h3>4) Время в Польше</h3>
      <select id="stayLength">
        <option value="2-3">2–3 года</option>
        <option value="<=1">год и меньше</option>
        <option value=">=4">больше 4 лет</option>
        <option value="new">только приехал</option>
      </select>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(3)">Назад</button>
        <button class="primary" onclick="nextQValidated(4,5)">Далее</button>
      </div>
    </div>

    <!-- Q5 -->
    <div id="q5" style="display:none">
      <h3>5) Текущий статус</h3>
      <select id="currentStatus">
        <option value="waiting">Жду</option>
        <option value="refused">Получил отказ</option>
        <option value="statusUKR">Status UKR</option>
        <option value="pobytCzasowy">Pobyt Czasowy</option>
        <option value="other">Inne (Karta Polaka, Karta Rezydenta UE)</option>
      </select>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(4)">Назад</button>
        <button class="primary" onclick="nextQValidated(5,6)">Далее</button>
      </div>
    </div>

    <!-- Q6 -->
    <div id="q6" style="display:none">
      <h3>6) Основания для ВНЖ</h3>
      <div class="small">Можно выбрать несколько.</div>
      <div style="margin:16px 0">
        <label class="custom-checkbox" data-value="UoP">
          <input type="checkbox" class="grounds" value="UoP" onchange="checkIncomeWarning()">
          <span class="custom-checkbox-text">Работа (UoP)</span>
        </label>
        <label class="custom-checkbox" data-value="UoD">
          <input type="checkbox" class="grounds" value="UoD" onchange="checkIncomeWarning()">
          <span class="custom-checkbox-text">Работа (UoD)</span>
        </label>
        <label class="custom-checkbox" data-value="UoZ">
          <input type="checkbox" class="grounds" value="UoZ" onchange="checkIncomeWarning()">
          <span class="custom-checkbox-text">Работа (UoZ)</span>
        </label>
        <label class="custom-checkbox" data-value="Dzialalnosc">
          <input type="checkbox" class="grounds" value="Dzialalnosc">
          <span class="custom-checkbox-text">Работа (Działalność)</span>
        </label>
        <label class="custom-checkbox" data-value="Study">
          <input type="checkbox" class="grounds" value="Study">
          <span class="custom-checkbox-text">Учёба</span>
        </label>
        <label class="custom-checkbox" data-value="Family">
          <input type="checkbox" class="grounds" value="Family">
          <span class="custom-checkbox-text">Семья</span>
        </label>
      </div>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(5)">Назад</button>
        <button class="primary" onclick="nextQValidated(6,7)">Далее</button>
      </div>
    </div>

    <!-- Q7 -->
    <div id="q7" style="display:none">
      <h3>7) Ежемесячный доход (brutto)</h3>
      <select id="income" onchange="checkIncomeWarning()">
        <option value="<4666">до 4666</option>
        <option value="4666-10000">4666–10000</option>
        <option value=">10000">10000+</option>
      </select>
      
      <div id="income_warning" class="status warn" style="display:none;margin-top:12px">
        <div style="text-align:center">
          <div style="font-size:20px;margin-bottom:8px">⚠️</div>
          <div><strong>Внимание!</strong> С доходом ниже 4666 PLN ты не сможешь податься на карту побыту по работе.</div>
          <div style="margin-top:8px;font-size:14px">Рекомендуем рассмотреть другие основания или увеличить доход.</div>
        </div>
      </div>
      
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(6)">Назад</button>
        <button class="primary" onclick="nextQValidated(7,8)">Далее</button>
      </div>
    </div>

    <!-- Q8 -->
    <div id="q8" style="display:none">
      <h3>8) Долгосрочная цель в Польше</h3>
      <select id="goal">
        <option value="wait">Переждать бурю</option>
        <option value="euResidentMaybe">Получить резидента, но насчёт паспорта неуверен</option>
        <option value="passport">Получить паспорт</option>
      </select>
      <div class="row" style="margin-top:16px">
        <button onclick="prevQ(7)">Назад</button>
        <button class="primary" onclick="finishOnb()">Продолжить</button>
      </div>
      <div class="small" style="margin-top:8px">PDF не генерируется на этом этапе</div>
    </div>
  </div>

  <!-- Чеклист -->
  <div id="home" style="display:none">
    <div class="card">
      <h3>Прогресс</h3>
      <div class="progress"><span id="progressBar" style="width:0%"></span></div>
      <div class="small" style="margin-top:6px">Готово: <span id="doneCount">0</span>/<span id="totalCount">0</span></div>
      <div id="officeHint" class="small hint"></div>
    </div>

    <div id="tasks"></div>

    <!-- 🔄 Временная кнопка сброса для тестов -->
    <div style="margin-top:16px; text-align:center">
      <button onclick="resetOnb()">🔄 Reset (для тестов)</button>
    </div>
  </div>
</div>

<!-- Нижнее меню -->
<div class="bottom">
  <button onclick="openChecklist()">Checklist</button>
  <button onclick="openModule('aiTranslator')">AI Translator</button>
  <button onclick="openModule('findSlot')">Book a slot</button>
  <button onclick="openModule('bookAssistant')">Start a chat</button>
</div>

<!-- ====== Контракт/Основание — модальный модуль -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <button class="ghost" style="flex:0 0 auto;width:auto" onclick="closeModal()">← Назад</button>
      <span></span>
    </div>

    <!-- экран 1: загрузка -->
    <div id="ct_step1">
      <h3>Загрузи документ для проверки</h3>
      <div class="small">Поддерживаются PDF, JPG, PNG (до ~20 МБ).</div>
      <div id="ct_checked_info" class="status ok" style="display:none;margin-top:10px"></div>
      <input id="ct_file" type="file" accept=".pdf,.jpg,.jpeg,.png,.webp" />
      <div class="hr"></div>
      <button id="ct_btn_upload" class="primary" disabled onclick="ctStart()">
        <span style="display:flex;align-items:center;justify-content:center;gap:8px">
          <span style="font-size:18px">🤖</span>
          <span>Проверить с AI</span>
        </span>
      </button>
      <div class="small muted" style="margin-top:12px;text-align:center">
        <a href="javascript:void(0)" onclick="ctNoDoc()" class="help-link">У меня нет — помогите</a>
      </div>
    </div>

    <!-- экран 2: дата завершения анализа -->
    <div id="ct_step2" style="display:none">
      <h3>AI анализ запущен</h3>
      <div class="completion-info" style="margin:20px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:16px">⏰</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Анализ будет готов</div>
        <div id="ct_completion_date" style="font-size:24px;color:var(--accent);font-weight:700;margin-bottom:8px"></div>
        <div id="ct_completion_time" style="font-size:16px;color:var(--muted)"></div>
      </div>
      <div class="status" id="ct_queue_msg" style="margin-top:16px">
        Твой анализ будет готов <span id="ct_time_remaining">через 24 часа</span>
      </div>
      <div class="small muted" style="margin-top:12px">
        Можешь ускорить AI и получить результат быстрее
      </div>
      <div style="margin-top:20px">
        <button id="ct_btn_boost" class="primary" onclick="ctBoost()" style="width:100%">Ускоряю!</button>
      </div>
      <div class="small muted" id="ct_poll_note" style="margin-top:8px"></div>
    </div>

    <!-- экран 3: оплата -->
    <div id="ct_step3" style="display:none">
      <h3>Ускорение AI анализа</h3>
      <div class="status" style="margin-top:16px">
        <div class="center">
          <div style="font-size:24px;color:var(--accent);margin-bottom:8px">⚡</div>
          <div>Результат за 1 час вместо 24 часов</div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="payment-details">
        <div class="payment-item">
          <span>Ускорение AI анализа</span>
          <span class="payment-price">50 PLN</span>
        </div>
        <div class="payment-item">
          <span>Приоритетная обработка</span>
          <span class="payment-price">+20 PLN</span>
        </div>
        <div class="hr"></div>
        <div class="payment-total">
          <span>Итого к оплате:</span>
          <span class="payment-price total">70 PLN</span>
        </div>
      </div>
      
      <div style="margin-top:20px">
        <button class="primary" onclick="ctProcessPayment()" style="width:100%;margin-bottom:12px">Оплатить</button>
        <button class="ghost" onclick="ctBackToTimer()" style="width:100%">Отмена</button>
      </div>
    </div>

    <!-- экран 4: результат -->
    <div id="ct_step4" style="display:none">
      <h3 id="ct_result_title">Ура! Всё удалось 🎉</h3>
      <div id="ct_result_box" class="status ok" style="margin-top:10px">
        <div id="ct_result_text">Все чётко. Замечаний нет.</div>
      </div>
      <div style="margin-top:20px">
        <button class="primary" onclick="ctBackToHome()" style="width:100%;margin-bottom:12px">Вернуться в главное меню</button>
        <button class="ghost" onclick="ctStartOver()" style="width:100%">Загрузить новый документ</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== Załącznik od pracodawcy — модальный модуль -->
<div id="załącznik_modal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <button class="ghost" style="flex:0 0 auto;width:auto" onclick="closeZałącznikModal()">← Назад</button>
      <span></span>
    </div>

    <!-- экран 1: загрузка -->
    <div id="załącznik_step1">
      <h3>Загрузи załącznik od pracodawcy для проверки</h3>
      <div class="small">Поддерживаются PDF, JPG, PNG (до ~20 МБ).</div>
      <div id="załącznik_checked_info" class="status ok" style="display:none;margin-top:10px"></div>
      <input id="załącznik_file" type="file" accept=".pdf,.jpg,.jpeg,.png,.webp" />
      <div class="hr"></div>
      <button id="załącznik_btn_upload" class="primary" disabled onclick="załącznikStart()">
        <span style="display:flex;align-items:center;justify-content:center;gap:8px">
          <span style="font-size:18px">🤖</span>
          <span>Проверить с AI</span>
        </span>
      </button>
      <div class="small muted" style="margin-top:12px;text-align:center">
        <a href="javascript:void(0)" onclick="załącznikNoDoc()" class="help-link">У меня нет — помогите</a>
      </div>
    </div>

    <!-- экран 2: дата завершения анализа -->
    <div id="załącznik_step2" style="display:none">
      <h3>AI анализ запущен</h3>
      <div class="completion-info" style="margin:20px 0;text-align:center">
        <div style="font-size:48px;margin-bottom:16px">⏰</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">Анализ будет готов</div>
        <div id="załącznik_completion_date" style="font-size:24px;color:var(--accent);font-weight:700;margin-bottom:8px"></div>
        <div id="załącznik_completion_time" style="font-size:16px;color:var(--muted)"></div>
      </div>
      <div class="status" id="załącznik_queue_msg" style="margin-top:16px">
        Твой анализ будет готов <span id="załącznik_time_remaining">через 24 часа</span>
      </div>
      <div class="small muted" style="margin-top:12px">
        Можешь ускорить AI и получить результат быстрее
      </div>
      <div style="margin-top:20px">
        <button id="załącznik_btn_boost" class="primary" onclick="załącznikBoost()" style="width:100%">Ускоряю!</button>
      </div>
      <div class="small muted" id="załącznik_poll_note" style="margin-top:8px"></div>
    </div>

    <!-- экран 3: оплата -->
    <div id="załącznik_step3" style="display:none">
      <h3>Ускорение AI анализа</h3>
      <div class="status" style="margin-top:16px">
        <div class="center">
          <div style="font-size:24px;color:var(--accent);margin-bottom:8px">⚡</div>
          <div>Результат за 1 час вместо 24 часов</div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="payment-details">
        <div class="payment-item">
          <span>Ускорение AI анализа</span>
          <span class="payment-price">50 PLN</span>
        </div>
        <div class="payment-item">
          <span>Приоритетная обработка</span>
          <span class="payment-price">+20 PLN</span>
        </div>
        <div class="hr"></div>
        <div class="payment-total">
          <span>Итого к оплате:</span>
          <span class="payment-price total">70 PLN</span>
        </div>
      </div>
      
      <div style="margin-top:20px">
        <button class="primary" onclick="załącznikProcessPayment()" style="width:100%;margin-bottom:12px">Оплатить</button>
        <button class="ghost" onclick="załącznikBackToTimer()" style="width:100%">Отмена</button>
      </div>
    </div>

    <!-- экран 4: результат -->
    <div id="załącznik_step4" style="display:none">
      <h3 id="załącznik_result_title">Ура! Всё удалось 🎉</h3>
      <div id="załącznik_result_box" class="status ok" style="margin-top:10px">
        <div id="załącznik_result_text">Все чётко. Замечаний нет.</div>
      </div>
      <div style="margin-top:20px">
        <button class="primary" onclick="załącznikBackToHome()" style="width:100%;margin-bottom:12px">Вернуться в главное меню</button>
        <button class="ghost" onclick="załącznikStartOver()" style="width:100%">Загрузить новый документ</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== Фотографии — модальный модуль -->
<div id="photos_modal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <button class="ghost" style="flex:0 0 auto;width:auto" onclick="closePhotosModal()">← Назад</button>
      <span></span>
    </div>

    <!-- экран 1: инструкции -->
    <div id="photos_step1">
      <h3>Требования к фотографиям для ВНЖ</h3>
      <div class="status" style="margin-top:14px">
        <div class="center">
          <div style="font-size:20px;margin-bottom:6px">📸</div>
          <div style="font-size:14px">Требуется 4 фотографии. Найди фото ателье рядом</div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="photo-requirements">
        <div class="requirement-item">
          <span>Размер:</span>
          <span class="requirement-value">35 x 45 мм</span>
        </div>
        <div class="requirement-item">
          <span>Фон:</span>
          <span class="requirement-value">Белый</span>
        </div>
        <div class="requirement-item">
          <span>Количество:</span>
          <span class="requirement-value">4 шт</span>
        </div>
        <div class="requirement-item">
          <span>Срок действия:</span>
          <span class="requirement-value">Не старше 6 мес</span>
        </div>
      </div>
      
      <div style="margin-top:20px">
        <button class="primary" onclick="findPhotoStudios()" style="width:100%">Найти фото ателье рядом</button>
      </div>
      
      <div class="center" style="margin-top:20px">
        <a href="javascript:void(0)" onclick="markPhotosDone()" style="text-decoration:underline;color:var(--accent)">
          Я сделал
        </a>
      </div>
    </div>

    <!-- экран 2: список фотоателье -->
    <div id="photos_step2" style="display:none">
      <h3 style="margin-bottom:12px">Фотоателье рядом с вами</h3>
      
      <div class="photo-studios">
        <div class="studio-item">
          <div class="studio-info">
            <h4>Foto Studio Centrum</h4>
            <div class="studio-details">
              <span>📍 ul. Marszałkowska 15, Warszawa</span>
              <span>📞 +48 22 123 45 67</span>
              <span>⏰ Пн-Пт 9:00-18:00</span>
            </div>
          </div>
          <div class="studio-actions">
            <button class="primary" onclick="callStudio('+48 22 123 45 67')">Позвонить</button>
            <button class="ghost" onclick="openMap('ul. Marszałkowska 15, Warszawa')">Карта</button>
          </div>
        </div>
        
        <div class="studio-item">
          <div class="studio-info">
            <h4>Foto Express</h4>
            <div class="studio-details">
              <span>📍 ul. Nowy Świat 28, Warszawa</span>
              <span>📞 +48 22 987 65 43</span>
              <span>⏰ Пн-Сб 8:00-20:00</span>
            </div>
          </div>
          <div class="studio-actions">
            <button class="primary" onclick="callStudio('+48 22 987 65 43')">Позвонить</button>
            <button class="ghost" onclick="openMap('ul. Nowy Świat 28, Warszawa')">Карта</button>
          </div>
        </div>
        
        <div class="studio-item">
          <div class="studio-info">
            <h4>Foto Pro</h4>
            <div class="studio-details">
              <span>📍 ul. Krakowskie Przedmieście 12, Warszawa</span>
              <span>📞 +48 22 555 44 33</span>
              <span>⏰ Пн-Вс 10:00-19:00</span>
            </div>
          </div>
          <div class="studio-actions">
            <button class="primary" onclick="callStudio('+48 22 555 44 33')">Позвонить</button>
            <button class="ghost" onclick="openMap('ul. Krakowskie Przedmieście 12, Warszawa')">Карта</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--line)">
        <button class="primary" onclick="markPhotosDone()" style="width:100%;margin-bottom:10px">Готово</button>
        <button class="ghost" onclick="backToPhotosStep1()" style="width:100%">Назад к требованиям</button>
      </div>
    </div>
    
    <!-- экран 3: фотографии уже сделаны -->
    <div id="photos_step3" style="display:none">
      <div class="status ok" style="margin-top:16px">
        <div class="center">
          <div style="font-size:48px;margin-bottom:16px">✅</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px">Фотографии готовы!</div>
          <div style="color:var(--muted)">Ты уже отметил фотографии как выполненные</div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div style="margin-top:20px">
        <button class="ghost" onclick="closePhotosModal()" style="width:100%;margin-bottom:12px">Закрыть</button>
        <button class="ghost" onclick="resetPhotosStatus()" style="width:100%;font-size:14px;color:var(--muted)">
          Сбросить статус (для тестирования)
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== Telegram init
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try { tg && tg.ready(); tg && tg.expand(); } catch(e) {}

  // ====== Custom checkbox handling
  document.addEventListener('DOMContentLoaded', function() {
    // Handle custom checkbox clicks - improved version
    document.addEventListener('click', function(e) {
      const label = e.target.closest('.custom-checkbox');
      if (label) {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox) {
          // Toggle checkbox state
          checkbox.checked = !checkbox.checked;
          
          // Update visual state
          if (checkbox.checked) {
            label.classList.add('checked');
          } else {
            label.classList.remove('checked');
          }
          
          // Trigger change event for form validation
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
          

        }
      }
    });
    
    // Also handle direct checkbox changes
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('grounds')) {
        const checkbox = e.target;
        const label = checkbox.closest('.custom-checkbox');
        
        if (checkbox.checked) {
          label.classList.add('checked');
        } else {
          label.classList.remove('checked');
        }
      }
    });
  });

  // ====== Простое состояние
  const st = {
    track: localStorage.getItem('track') || null,
    tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
    profile: JSON.parse(localStorage.getItem('profile')||'{}')
  };

  // ====== Конфиг AI-модуля
  const BACKEND_BASE = ""; // ← если есть сервер/бот API, укажите базовый URL
  const ENDPOINTS = BACKEND_BASE ? {
    upload: BACKEND_BASE + "/upload",
    analyze: BACKEND_BASE + "/analyze",
    status: BACKEND_BASE + "/status"
  } : null;

  const AI_PROMPT = `Проверь загруженный документ (контракт/основание на ВНЖ в Польше).
1) Валидация реквизитов: стороны, NIP/PESEL (если есть), адреса, даты, подписи, срок действия.
2) Несоответствия: несовпадение ФИО с анкетой пользователя, пустые поля, просроченные даты.
3) Риски для ВНЖ: пункты, которые могут вызвать отказ (неполная занятость, нет адреса, нет основания).
4) Итог: короткий вердикт (OK / есть замечания) и чеклист исправлений.
Выводи список пунктов с краткими пояснениями. Язык ответа — русский.`;

  // ====== Базовые задачи
  function baseTasks(track){
    const common = [
      {id:'wniosek', title:'Wniosek (PDF)', status:'todo', requiresAI:true, kind:'wniosek'},
      {id:'photos', title:'Фотографии', status:'todo', requiresAI:false, kind:'photos'},
      {id:'skarb', title:'Opłata skarbowa', status:'todo', requiresAI:false, kind:'skarb'},
      {id:'rent', title:'Umowa najmu / Meldunek', status:'todo', requiresAI:true, kind:'rent'},
      {id:'ins', title:'Ubezpieczenie', status:'todo', requiresAI:true, kind:'insurance'},
      {id:'slot', title:'Find a slot', status:'todo', requiresAI:false, kind:'slot'},
      {id:'ai', title:'AI Translator', status:'todo', requiresAI:false, kind:'aiTranslator'},
      {id:'assist', title:'Book an assistant', status:'todo', requiresAI:false, kind:'bookAssistant'}
    ];
    if(track==='work'||track==='business'){
      common.splice(2,0,{id:'contract', title:'Контракт / Основание', status:'todo', requiresAI:true, kind:'contract'});
      common.splice(3,0,{id:'załącznik', title:'Załącznik od pracodawcy', status:'todo', requiresAI:true, kind:'załącznik'});
    }
    if(track==='study'){
      common.splice(2,0,{id:'uni', title:'Справка из вуза', status:'todo', requiresAI:true, kind:'university'});
      common.splice(3,0,{id:'funds', title:'Информация о средствах', status:'todo', requiresAI:true, kind:'funds'});
    }
    return common;
  }

  // ====== Voivodeship hint
  function officeHintByVoiv(v){
    const map = {
      'Mazowieckie': 'Ваш ужонд: Mazowiecki Urząd Wojewódzki w Warszawie, pl. Bankowy 3/5, 00-950 Warszawa',
      'Małopolskie': 'Ваш ужонд: Małopolski Urząd Wojewódzki w Krakowie, Wydział Spraw Cudzoziemców, ul. Przy Rondzie 6, 31-547 Kraków',
      'Pomorskie': 'Ваш ужонд: Pomorski Urząd Wojewódzki w Gdańsku, ul. Okopowa 21/27, 80-810 Gdańsk (Важно: отправлять документы только на этот адрес)',
      'Dolnośląskie': 'Ваш ужонд: Dolnośląski Urząd Wojewódzki we Wrocławiu, pl. Powstańców Warszawy 1, 50-153 Wrocław',
      'Kujawsko-Pomorskie': 'Ваш ужонд: Kujawsko-Pomorski Urząd Wojewódzki w Bydgoszczy, ul. Jagiellońska 3, 85-950 Bydgoszcz',
      'Lubelskie': 'Ваш ужонд: Lubelski Urząd Wojewódzki w Lublinie, ul. Spokojna 4, 20-914 Lublin (с пометкой «Wydział Spraw Obywatelskich i Cudzoziemców»)',
      'Lubuskie': 'Ваш ужонд: Lubuski Urząd Wojewódzki w Gorzowie Wielkopolskim, ul. Jagiellończyka 8, 66-400 Gorzów Wielkopolski',
      'Łódzkie': 'Ваш ужонд: Łódzki Urząd Wojewódzki w Łodzi, ul. Piotrkowska 104, 90-926 Łódź',
      'Opolskie': 'Ваш ужонд: Opolski Urząd Wojewódzki w Opolu, Wydział Spraw Obywatelskich i Cudzoziemców, ul. Piastowska 14, 45-082 Opole',
      'Podkarpackie': 'Ваш ужонд: Podkarpacki Urząd Wojewódzki w Rzeszowie, ul. Grunwaldzka 15, 35-959 Rzeszów',
      'Podlaskie': 'Ваш ужонд: Podlaski Urząd Wojewódzki w Białymstoku, ul. Mickiewicza 3, 15-213 Białystok',
      'Śląskie': 'Ваш ужонд: Śląski Urząd Wojewódzki w Katowicach, Wydział Spraw Cudzoziemców, ul. Jagiellońska 25, 40-032 Katowice',
      'Świętokrzyskie': 'Ваш ужонд: Świętokrzyski Urząd Wojewódzki w Kielcach, al. IX Wieków Kielc 3, 25-516 Kielce',
      'Warmińsko-Mazurskie': 'Ваш ужонд: Warmińsko-Mazurski Urząd Wojewódzki w Olsztynie, Al. Marsz. J. Piłsudskiego 7/9, 10-575 Olsztyn',
      'Wielkopolskie': 'Ваш ужонд: Wielkopolski Urząd Wojewódzki w Poznaniu, al. Niepodległości 16/18, 61-713 Poznań',
      'Zachodniopomorskie': 'Ваш ужонд: Zachodniopomorski Urząd Wojewódzki w Szczecinie, ul. Wały Chrobrego 4, 70-502 Szczecin',
      'Inne': 'Подсказки по ужондам для вашего региона: https://gov.example'
    };
    return map[v] || '';
  }

  // ====== Track detection
  function determineTrack(groundValues){
    const has = k => groundValues.includes(k);
    if (has('Study')) return 'study';
    if (has('Family')) return 'family';
    if (has('Dzialalnosc')) return 'business';
    if (has('UoP') || has('UoD') || has('UoZ')) return 'work';
    return 'work';
  }

  // ====== Checklist render
  function renderChecklist(){
    const title = st.profile?.trackLabel ? `eMigrant · Чеклист (${st.profile.trackLabel})` : 'eMigrant · Чеклист';
    document.getElementById('title').innerText = title;

    const tasksDiv = document.getElementById('tasks');
    tasksDiv.innerHTML = '';
    const done = st.tasks.filter(t=>t.status==='done').length;
    const total = st.tasks.length || 1;
    document.getElementById('doneCount').innerText = done;
    document.getElementById('totalCount').innerText = total;
    document.getElementById('progressBar').style.width = Math.round(done/total*100)+'%';
    document.getElementById('officeHint').innerText = st.profile?.voivodeship ? officeHintByVoiv(st.profile.voivodeship) : '';

    st.tasks.forEach((t, index)=>{
      const card = document.createElement('div');
      card.className='card';
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      const badgeClass = t.status==='done'?'ok':(t.status==='inreview'?'warn':'');
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <div style="flex:3">
            <h3 style="margin:0 0 6px">${t.title}</h3>
            <span class="badge ${badgeClass}">${t.status==='todo'?'To do':t.status==='inreview'?'In review':'Done'}</span>
            ${(t.requiresAI && t.status!=='done')?'<span class="small" style="margin-left:8px">Рекомендуется AI-проверка</span>':''}
          </div>
          <div style="flex:2">
            <div class="row">
              <button class="primary" onclick="openModule('${t.kind}')">Открыть</button>
              ${t.status!=='done'?'<button onclick="markDone(\''+t.id+'\')">Сделано</button>':''}
            </div>
          </div>
        </div>
      `;
      tasksDiv.appendChild(card);
      
      // Анимация появления карточки с задержкой
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 100);
    });
  }

  function markDone(id){
    st.tasks = st.tasks.map(t=> t.id===id ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    renderChecklist();
  }

  // ====== Навигация
  function openChecklist(){
    const onb = document.getElementById('onb');
    const home = document.getElementById('home');
    
    onb.style.opacity = '0';
    onb.style.transform = 'translateY(-20px)';
    onb.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      onb.style.display = 'none';
      home.style.display = 'block';
      home.style.opacity = '0';
      home.style.transform = 'translateY(20px)';
      home.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        home.style.opacity = '1';
        home.style.transform = 'translateY(0)';
    renderChecklist();
      }, 10);
    }, 400);
  }

  function openModule(kind){
    if(kind==='aiTranslator'){
      alert('AI Translator: Загрузите письмо/документ → перевод и краткое резюме. (В MVP-заглушке загрузка опущена)');
      return;
    }
    if(kind==='findSlot'){
      const dates = prompt('Укажите даты/дни, когда вы доступны (например: Пн/Ср/Пт или 20-25 августа). Мы мониторим, но слот не гарантирован.');
      alert('Спасибо! Подписка на обновления оформлена.\nВаши доступные дни: '+(dates||'не указано')+'\nПодтверждение визита — вручную.');
      return;
    }
    if(kind==='bookAssistant'){
      const text = prompt('Коротко опишите, о чём поговорить. Заявка уйдёт в отдельный чат-аккаунт.');
      alert('Заявка отправлена. Нажмите ОК, чтобы открыть чат с ассистентом.');
      if(tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/'+(tg.initDataUnsafe?.user?.username||''));
      return;
    }
    if(kind==='photos'){
      openPhotosModal();
      return;
    }
    if(kind==='insurance'){
      const has = confirm('Есть действующая страховка? (OK — да; Отмена — нет)');
      if(!has){
        alert('Нажмите «Написать в чат», чтобы обсудить, как оформить страховку.');
        if(tg && tg.openTelegramLink) tg.openTelegramLink('https://t.me/'+(tg.initDataUnsafe?.user?.username||'')); 
      } else {
        alert('Загрузите полис. AI-проверка: срок действия и реквизиты.');
      }
      return;
    }
    if(kind==='wniosek'){
      const path = confirm('У вас уже есть готовый скан внеска? (OK — загрузить скан; Отмена — пройти анкету и сгенерировать PDF)');
      if(path){
        alert('Загрузите скан. AI-проверка: подпись, даты, совпадение ФИО.');
      } else {
        alert('Откроется анкета внеска → затем можно сгенерировать PDF и распечатать.');
      }
      return;
    }
    if(kind==='contract'){ openContractModal(); return; }
    if(kind==='załącznik'){ openZałącznikModal(); return; }
    if(kind==='attachmentHR'){
      alert('Скачайте шаблон, отдайте HR. Затем загрузите подписанный/с печатью документ (AI-проверка).');
      return;
    }
    if(kind==='rent'){
      alert('Загрузите договор аренды или meldunek. AI-проверка: адрес, сроки, подписи. Если нет — покажем инструкцию.');
      return;
    }
    if(kind==='university'){
      alert('Справка из вуза: Загрузка → AI-проверка. Если нет — инструкция, где получить.');
      return;
    }
    if(kind==='funds'){
      alert('Информация о средствах: Загрузите банковскую справку. AI-проверка — сумма/дата/реквизиты.');
      return;
    }
    if(kind==='skarb'){
      const paid = confirm('Оплатили госпошлину? (OK — да; Отмена — нет)');
      if(paid){
        alert('Отметили как выполнено. (Можно прикрепить чек — опционально в MVP)');
      } else {
        alert('Покажем реквизиты и короткую инструкцию по оплате.');
      }
      return;
    }
  }

  // ====== Онбординг
  function showQ(n){
    // Анимация перехода между вопросами
    const currentQ = document.querySelector('#onb [id^="q"]:not([style*="display: none"])');
    const nextQ = document.getElementById('q'+n);
    
    if(currentQ && nextQ && currentQ !== nextQ){
      // Анимация исчезновения текущего вопроса
      currentQ.style.opacity = '0';
      currentQ.style.transform = 'translateX(-20px)';
      currentQ.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        // Скрываем все вопросы
        for(let i=1;i<=8;i++){ 
          const q = document.getElementById('q'+i);
          q.style.display = (i===n)?'':'none';
          q.style.opacity = '1';
          q.style.transform = 'translateX(0)';
        }
        
        // Анимация появления следующего вопроса
        nextQ.style.opacity = '0';
        nextQ.style.transform = 'translateX(20px)';
        nextQ.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        setTimeout(() => {
          nextQ.style.opacity = '1';
          nextQ.style.transform = 'translateX(0)';
          
          // Проверяем предупреждение о доходе для вопроса 7
          if(n === 7) {
            setTimeout(() => checkIncomeWarning(), 50);
          }
        }, 10);
      }, 300);
    } else {
      // Простое переключение без анимации
    for(let i=1;i<=8;i++){ document.getElementById('q'+i).style.display = (i===n)?'':'none' }
    
    // Проверяем предупреждение о доходе для вопроса 7
    if(n === 7) {
      setTimeout(() => checkIncomeWarning(), 50);
    }
    }
    
    document.getElementById('step').innerText = String(n);
  }
  function prevQ(n){ showQ(n) }

  function isAnswered(step){
    switch(step){
      case 1:{
        const fn=document.getElementById('firstName'), ln=document.getElementById('lastName');
        if(!fn.value.trim()){fn.focus();alert('Пожалуйста, укажи имя.');return false;}
        if(!ln.value.trim()){ln.focus();alert('Пожалуйста, укажи фамилию.');return false;}
        return true;
      }
      case 2:{ const s=document.getElementById('voivodeship'); if(!s.value){s.focus();alert('Выбери воеводство.'); return false;} return true; }
      case 3:{ const s=document.getElementById('citizenship'); if(!s.value){s.focus();alert('Выбери гражданство.'); return false;} return true; }
      case 4:{ const s=document.getElementById('stayLength'); if(!s.value){s.focus();alert('Укажи срок пребывания.'); return false;} return true; }
      case 5:{ const s=document.getElementById('currentStatus'); if(!s.value){s.focus();alert('Выбери текущий статус.'); return false;} return true; }
      case 6:{ const any=Array.from(document.querySelectorAll('.grounds')).some(el=>el.checked); if(!any){alert('Выбери хотя бы одно основание.'); return false;} return true; }
      case 7:{ const s=document.getElementById('income'); if(!s.value){s.focus();alert('Укажи доход.'); return false;} return true; }
      case 8:{ const s=document.getElementById('goal'); if(!s.value){s.focus();alert('Выбери цель.'); return false;} return true; }
      default:return true;
    }
  }
  function nextQValidated(curr,next){ if(isAnswered(curr)){ showQ(next); } }

  function finishOnb(){
    for(let i=1;i<=8;i++){ if(!isAnswered(i)){ showQ(i); return; } }

    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const voivodeship = document.getElementById('voivodeship').value;
    const citizenship = document.getElementById('citizenship').value;
    const stayLength = document.getElementById('stayLength').value;
    const currentStatus = document.getElementById('currentStatus').value;
    const income = document.getElementById('income').value;
    const goal = document.getElementById('goal').value;
    const grounds = Array.from(document.querySelectorAll('.grounds')).filter(el=>el.checked).map(el=>el.value);

    // Проверяем, есть ли конфликт между доходом и основанием "Работа"
    const workGrounds = ['UoP', 'UoD', 'UoZ'];
    const hasWorkGround = workGrounds.some(ground => grounds.includes(ground));
    
    if(income === '<4666' && hasWorkGround){
      const proceed = confirm(
        '⚠️ Внимание! С доходом ниже 4666 PLN ты не сможешь податься на карту побыту по работе.\n\n' +
        'Ты уверен, что хочешь продолжить с текущими данными?\n\n' +
        'Рекомендуем:\n' +
        '• Увеличить доход до 4666+ PLN\n' +
        '• Выбрать другие основания (Учёба, Семья)\n' +
        '• Обратиться за консультацией'
      );
      
      if(!proceed){
        showQ(7); // Возвращаемся к вопросу о доходе
        return;
      }
    }

    const track = determineTrack(grounds);
    const trackLabel = track==='work'?'Работа':track==='study'?'Учёба':track==='family'?'Семья':'Бизнес';

    st.profile = { firstName, lastName, voivodeship, citizenship, stayLength, currentStatus, grounds, income, goal, track, trackLabel };
    localStorage.setItem('profile', JSON.stringify(st.profile));

    st.track = track;
    st.tasks = baseTasks(track);
    localStorage.setItem('track', track);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));

    // Анимация завершения онбординга
    const onb = document.getElementById('onb');
    const home = document.getElementById('home');
    
    onb.style.opacity = '0';
    onb.style.transform = 'translateY(-20px)';
    onb.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      onb.style.display='none';
      home.style.display='';
      home.style.opacity = '0';
      home.style.transform = 'translateY(20px)';
      home.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        home.style.opacity = '1';
        home.style.transform = 'translateY(0)';
    renderChecklist();
      }, 10);
    }, 400);
  }

  // ====== Проверка дохода для карты побыту
  function checkIncomeWarning(){
    const income = document.getElementById('income').value;
    const warning = document.getElementById('income_warning');
    
    // Проверяем, выбрано ли основание "Работа"
    const workGrounds = ['UoP', 'UoD', 'UoZ'];
    const selectedGrounds = Array.from(document.querySelectorAll('.grounds:checked')).map(el => el.value);
    const hasWorkGround = workGrounds.some(ground => selectedGrounds.includes(ground));
    
    if(income === '<4666' && hasWorkGround){
      warning.style.display = 'block';
    } else {
      warning.style.display = 'none';
    }
  }

  // ====== Reset (тесты)
  function resetOnb(){
    if(confirm("Сбросить анкету и начать сначала?")){
      localStorage.removeItem('track');
      localStorage.removeItem('tasks');
      localStorage.removeItem('profile');
      st.track = null; st.tasks=[]; st.profile={};
      const home = document.getElementById('home');
      const onb = document.getElementById('onb');
      
      home.style.opacity = '0';
      home.style.transform = 'translateY(20px)';
      home.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        home.style.display='none';
        onb.style.display='';
        onb.style.opacity = '0';
        onb.style.transform = 'translateY(-20px)';
        onb.style.transition = 'all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        setTimeout(() => {
          onb.style.opacity = '1';
          onb.style.transform = 'translateY(0)';
      showQ(1);
        }, 10);
      }, 400);
    }
  }

  // ====== Контракт — модальное окно и логика
  let ct = { file: null, fileMeta: null, jobId: null, pollTimer: null, boosted:false };
  
  // ====== Załącznik od pracodawcy — модальное окно и логика
  let załącznik = { file: null, fileMeta: null, jobId: null, pollTimer: null, boosted:false };

  function el(id){ return document.getElementById(id); }
  function openContractModal(){
    ct = { file:null, fileMeta:null, jobId:null, pollTimer:null, boosted:false };
    
    // В Telegram Mini App header уже скрыт, просто добавляем класс
    const wrap = document.querySelector('.wrap');
    if(wrap) wrap.classList.add('no-header');
    
    const modal = el('modal');
    modal.style.display='grid';
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
    
    // Проверяем статус задачи
    const task = (st.tasks||[]).find(t=>t.id==='contract');
    
    if(task && task.status==='inreview'){
      // Если документ был проанализирован но есть проблемы - показываем результат
      el('ct_step1').style.display='none';
      el('ct_step2').style.display='none';
      el('ct_step3').style.display='none';
      el('ct_step4').style.display='';
      // Показываем результат с красными флагами
      showRedFlagsResult();
    } else if(task && task.status==='done'){
      // Если документ уже проверен успешно - показываем результат
      el('ct_step1').style.display='none';
      el('ct_step2').style.display='none';
      el('ct_step3').style.display='none';
      el('ct_step4').style.display='';
      // Показываем результат успеха
      showSuccessResult();
    } else {
      // Обычное состояние - показываем первый экран
    el('ct_step1').style.display='';
    el('ct_step2').style.display='none';
    el('ct_step3').style.display='none';
      el('ct_step4') && (el('ct_step4').style.display='none');
      
      // показать отметку если уже проверено
      try{
      const info = el('ct_checked_info');
      if(task && task.status==='done'){
        const ts = localStorage.getItem('contractCheckedAt');
        const dateStr = ts ? new Date(Number(ts)).toLocaleString() : new Date().toLocaleString();
        info.style.display='block';
        info.innerText = `Документ проверен: ${dateStr}`;
      } else {
        if(info){ info.style.display='none'; info.innerText=''; }
      }
    }catch(e){}
    
      el('ct_btn_upload').disabled = true;
      el('ct_file').value = '';
    }
  }
  function closeModal(){
    const modal = el('modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display='none';
      if(ct.pollTimer){ clearInterval(ct.pollTimer); ct.pollTimer=null; }
      
      // В Telegram Mini App возвращаем только отступ
      const wrap = document.querySelector('.wrap');
      if(wrap) wrap.classList.remove('no-header');
    }, 300);
  }
  function ctBackToHome(){ 
    closeModal(); 
    // В Telegram Mini App просто убираем класс
    const wrap = document.querySelector('.wrap');
    if(wrap) wrap.classList.remove('no-header');
    openChecklist(); 
  }

  function załącznikBackToHome(){ 
    closeZałącznikModal(); 
    // В Telegram Mini App просто убираем класс
    const wrap = document.querySelector('.wrap');
    if(wrap) wrap.classList.remove('no-header');
    openChecklist(); 
  }
  
  function ctStartOver(){
    // Сбрасываем статус задачи если нужно
    const task = st.tasks.find(t => t.id === 'contract');
    if(task && task.status === 'inreview'){
      st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'todo'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
      // Обновляем чеклист
      try { renderChecklist(); } catch(e) {}
    }
    
    // Очищаем localStorage от даты завершения
    localStorage.removeItem('contractTimerEnd');
    
    // Сбрасываем анимационные стили для всех экранов
    const steps = ['ct_step1', 'ct_step2', 'ct_step3', 'ct_step4'];
    steps.forEach(stepId => {
      const step = el(stepId);
      if(step){
        step.style.opacity = '1';
        step.style.transform = 'translateX(0)';
        step.style.transition = '';
      }
    });
    
    // Возвращаемся к первому экрану
    el('ct_step4').style.display='none';
    el('ct_step3').style.display='none';
    el('ct_step2').style.display='none';
    el('ct_step1').style.display='block';
    
    // Сбрасываем состояние
      ct = { file:null, fileMeta:null, jobId:null, pollTimer:null, boosted:false };
    el('ct_btn_upload').disabled = true;
    el('ct_file').value = '';
    
    // Скрываем информацию о предыдущей проверке
    const info = el('ct_checked_info');
    if(info){ info.style.display='none'; info.innerText=''; }
  }

  function załącznikStartOver(){
    // Сбрасываем статус задачи если нужно
    const task = st.tasks.find(t => t.id === 'załącznik');
    if(task && task.status === 'inreview'){
      st.tasks = st.tasks.map(t=> t.id==='załącznik' ? {...t, status:'todo'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
      // Обновляем чеклист
      try { renderChecklist(); } catch(e) {}
    }
    
    // Очищаем localStorage от даты завершения
    localStorage.removeItem('załącznikTimerEnd');
    
    // Сбрасываем анимационные стили для всех экранов
    const steps = ['załącznik_step1', 'załącznik_step2', 'załącznik_step3', 'załącznik_step4'];
    steps.forEach(stepId => {
      const step = el(stepId);
      if(step){
        step.style.opacity = '1';
        step.style.transform = 'translateX(0)';
        step.style.transition = '';
      }
    });
    
    // Возвращаемся к первому экрану
    el('załącznik_step4').style.display='none';
    el('załącznik_step3').style.display='none';
    el('załącznik_step2').style.display='none';
    el('załącznik_step1').style.display='block';
    
    // Сбрасываем состояние
    załącznik = { file:null, fileMeta:null, jobId:null, pollTimer:null, boosted:false };
    el('załącznik_btn_upload').disabled = true;
    el('załącznik_file').value = '';
    
    // Скрываем информацию о предыдущей проверке
    const info = el('załącznik_checked_info');
    if(info){ info.style.display='none'; info.innerText=''; }
  }

  // ====== Фотографии — функции модуля
  function openPhotosModal(){
    // В Telegram Mini App header уже скрыт, просто добавляем класс
    const wrap = document.querySelector('.wrap');
    if(wrap) wrap.classList.add('no-header');
    
    const modal = el('photos_modal');
    modal.style.display='grid';
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
    
    // Проверяем статус задачи фотографий
    const photosTask = st.tasks.find(t => t.id === 'photos');
    
    if (photosTask && photosTask.status === 'done') {
      // Если фотографии уже сделаны, показываем экран завершения
      el('photos_step1').style.display='none';
      el('photos_step2').style.display='none';
      showPhotosCompletedScreen();
    } else {
      // Если фотографии еще не сделаны, показываем обычный экран
      el('photos_step1').style.display='';
      el('photos_step2').style.display='none';
      
      // Сбрасываем анимацию для первого экрана
      const step1 = el('photos_step1');
      step1.style.opacity = '1';
      step1.style.transform = 'translateX(0)';
    }
  }
  
  function closePhotosModal(){
    const modal = el('photos_modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display='none';
      
      // Сбрасываем все экраны для следующего открытия
      el('photos_step1').style.display='none';
      el('photos_step2').style.display='none';
      el('photos_step3').style.display='none';
      
      // В Telegram Mini App возвращаем только отступ
      const wrap = document.querySelector('.wrap');
      if(wrap) wrap.classList.remove('no-header');
    }, 300);
  }

  function openZałącznikModal(){
    // В Telegram Mini App header уже скрыт, просто добавляем класс
    const wrap = document.querySelector('.wrap');
    if(wrap) wrap.classList.add('no-header');
    
    const modal = el('załącznik_modal');
    modal.style.display='grid';
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
    
    // Сначала скрываем все экраны
    el('załącznik_step1').style.display='none';
    el('załącznik_step2').style.display='none';
    el('załącznik_step3').style.display='none';
    el('załącznik_step4').style.display='none';
    
    // Проверяем статус задачи załącznik
    const task = st.tasks.find(t => t.id === 'załącznik');
    if(task && task.status === 'inreview'){
      el('załącznik_step4').style.display='block';
      if(task.result === 'redflags'){
        showZałącznikRedFlagsResult();
      } else {
        showZałącznikSuccessResult();
      }
    } else if(task && task.status === 'done'){
      el('załącznik_step4').style.display='block';
      showZałącznikSuccessResult();
    } else {
      el('załącznik_step1').style.display='block';
    }
  }

  function closeZałącznikModal(){
    const modal = el('załącznik_modal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display='none';
      
      // Сбрасываем все экраны для следующего открытия
      el('załącznik_step1').style.display='none';
      el('załącznik_step2').style.display='none';
      el('załącznik_step3').style.display='none';
      el('załącznik_step4').style.display='none';
      
      // Очищаем таймер если есть
      if(załącznik.pollTimer){ clearInterval(załącznik.pollTimer); załącznik.pollTimer=null; }
      
      // Очищаем состояние załącznik
      załącznik = { file:null, fileMeta:null, jobId:null, pollTimer:null, boosted:false };
      
      // Сбрасываем поля формы
      el('załącznik_btn_upload').disabled = true;
      el('załącznik_file').value = '';
      
      // Скрываем информацию о проверке
      const info = el('załącznik_checked_info');
      if(info){ info.style.display='none'; info.innerText=''; }
      
      // В Telegram Mini App возвращаем только отступ
      const wrap = document.querySelector('.wrap');
      if(wrap) wrap.classList.remove('no-header');
    }, 300);
  }
  
  function findPhotoStudios(){
    const step1 = el('photos_step1');
    const step2 = el('photos_step2');
    
    step1.style.opacity = '0';
    step1.style.transform = 'translateX(-20px)';
    step1.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step1.style.display='none';
      step2.style.display='';
      step2.style.opacity = '0';
      step2.style.transform = 'translateX(20px)';
      step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step2.style.opacity = '1';
        step2.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }
  
  function backToPhotosStep1(){
    const step2 = el('photos_step2');
    const step1 = el('photos_step1');
    
    step2.style.opacity = '0';
    step2.style.transform = 'translateX(20px)';
    step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step2.style.display='none';
      step1.style.display='';
      step1.style.opacity = '0';
      step1.style.transform = 'translateX(-20px)';
      step1.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step1.style.opacity = '1';
        step1.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }
  
  function markPhotosDone(){
    // Помечаем задачу как выполненную
    st.tasks = st.tasks.map(t=> t.id==='photos' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    
    // Обновляем чеклист
    try { renderChecklist(); } catch(e) {}
    
    // Закрываем модальное окно
    closePhotosModal();
    
    // Показываем уведомление
    alert('Отлично! Фотографии отмечены как выполненные. 🎉');
  }
  
  function showPhotosCompletedScreen(){
    // Скрываем все экраны
    el('photos_step1').style.display='none';
    el('photos_step2').style.display='none';
    
    // Показываем экран завершения
    const step3 = el('photos_step3');
    step3.style.display='';
    step3.style.opacity = '0';
    step3.style.transform = 'translateY(20px)';
    step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step3.style.opacity = '1';
      step3.style.transform = 'translateY(0)';
    }, 10);
  }
  
  function resetPhotosStatus(){
    // Сбрасываем статус задачи фотографий
    st.tasks = st.tasks.map(t=> t.id==='photos' ? {...t, status:'todo'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    
    // Обновляем чеклист
    try { renderChecklist(); } catch(e) {}
    
    // Показываем первый экран
    el('photos_step3').style.display='none';
    el('photos_step2').style.display='none';
    
    const step1 = el('photos_step1');
    step1.style.display='';
    step1.style.opacity = '0';
    step1.style.transform = 'translateY(20px)';
    step1.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step1.style.opacity = '1';
      step1.style.transform = 'translateY(0)';
    }, 10);
  }
  
  function callStudio(phone){
    // Открываем звонок
    if(tg && tg.openTelegramLink){
      tg.openTelegramLink(`tel:${phone}`);
    } else {
      window.open(`tel:${phone}`, '_blank');
    }
  }
  
  function openMap(address){
    // Открываем карту с адресом
    const mapUrl = `https://maps.google.com/?q=${encodeURIComponent(address)}`;
    if(tg && tg.openTelegramLink){
      tg.openTelegramLink(mapUrl);
    } else {
      window.open(mapUrl, '_blank');
    }
  }

  // enable button when file chosen
  el('ct_file').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    ct.file = f || null;
    el('ct_btn_upload').disabled = !ct.file;
  });

  // enable button when file chosen for załącznik
  el('załącznik_file').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    załącznik.file = f || null;
    el('załącznik_btn_upload').disabled = !załącznik.file;
  });

  function ctNoDoc(){
    // Закрываем модальное окно
    closeModal();
    
    // Открываем чат в Telegram с готовым сообщением
    if(tg && tg.openTelegramLink){
      // Формируем готовое сообщение
      const message = encodeURIComponent('Здравствуйте, у меня нету контракта на работу. Хотел бы попросить о помощи');
      
      // Открываем чат с пользователем @emigrate_support
      const chatUrl = `https://t.me/emigrate_support?text=${message}`;
      
      try {
        tg.openTelegramLink(chatUrl);
      } catch(e) {
        // Fallback: открываем в браузере
        window.open(chatUrl, '_blank');
      }
    } else {
      // Если Telegram Web App недоступен, показываем инструкцию
      alert('Здравствуйте, у меня нету контракта на работу. Хотел бы попросить о помощи\n\nНапишите нам в Telegram: @emigrate_support');
    }
  }

  function załącznikNoDoc(){
    // Закрываем модальное окно
    closeZałącznikModal();
    
    // Открываем чат в Telegram с готовым сообщением
    if(tg && tg.openTelegramLink){
      // Формируем готовое сообщение
      const message = encodeURIComponent('Здравствуйте, у меня нету załącznik od pracodawcy. Хотел бы попросить о помощи');
      
      // Открываем чат с пользователем @emigrate_support
      const chatUrl = `https://t.me/emigrate_support?text=${message}`;
      
      try {
        tg.openTelegramLink(chatUrl);
      } catch(e) {
        // Fallback: открываем в браузере
        window.open(chatUrl, '_blank');
      }
    } else {
      // Если Telegram Web App недоступен, показываем инструкцию
      alert('Здравствуйте, у меня нету załącznik od pracodawcy. Хотел бы попросить о помощи\n\nНапишите нам в Telegram: @emigrate_support');
    }
  }

  async function ctStart(){
    if(!ct.file){ alert('Выберите файл.'); return; }
    
    // Анимация перехода между экранами
    const step1 = el('ct_step1');
    const step2 = el('ct_step2');
    
    step1.style.opacity = '0';
    step1.style.transform = 'translateX(-20px)';
    step1.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step1.style.display='none';
      step2.style.display='';
      step2.style.opacity = '0';
      step2.style.transform = 'translateX(20px)';
      step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step2.style.opacity = '1';
        step2.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
    
    el('ct_step3').style.display='none';
    el('ct_step4').style.display='none';
    el('ct_poll_note').innerText = '';
    
    // Показываем дату завершения анализа если нет backend
    if(!ENDPOINTS){
      showCompletionDate();
    }

    try{
      // 1) загрузка файла
      let uploadRes = null;
      if(ENDPOINTS){
        const fd = new FormData();
        fd.append('file', ct.file);
        fd.append('source', 'emigrant_webapp');
        const resp = await fetch(ENDPOINTS.upload, { method:'POST', body: fd });
        if(!resp.ok) throw new Error('Upload failed');
        uploadRes = await resp.json(); // ожидаем {file_id, file_url, name, size}
      } else {
        // fallback: шлём боту метаданные, пусть он продолжит в чате
        uploadRes = { file_id: null, file_url: null, name: ct.file.name, size: ct.file.size };
      }

      ct.fileMeta = uploadRes;

      // 2) запуск анализа
      let analyzeRes = null;
      if(ENDPOINTS){
        const body = { file_id: uploadRes.file_id, file_url: uploadRes.file_url, prompt: AI_PROMPT, priority: ct.boosted?'high':'normal' };
        const resp = await fetch(ENDPOINTS.analyze, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!resp.ok) throw new Error('Analyze start failed');
        analyzeRes = await resp.json(); // ожидаем {job_id}
        ct.jobId = analyzeRes.job_id;
        startPolling();
      } else {
        // отправляем в бота, который читает web_app_data
        try{
          tg && tg.sendData && tg.sendData(JSON.stringify({
            type:'analyze_contract',
            prompt: AI_PROMPT,
            fileMeta: { name: ct.file.name, size: ct.file.size },
            note:'Нет подключенного backend ENDPOINTS — передано в бота через sendData'
          }));
          // НЕ запускаем fakeFinishOk() сразу - ждем таймер на 24 часа
        }catch(e){}
      }

    }catch(err){
      console.error(err);
      el('ct_queue_msg').innerText = 'Не удалось запустить анализ. Попробуйте ещё раз.';
      el('ct_btn_boost').disabled = true;
    }
  }

  // Функция показа даты завершения анализа
  function showCompletionDate(){
    // Устанавливаем время окончания: текущее время + 24 часа
    const endTime = new Date().getTime() + (24 * 60 * 60 * 1000);
    const completionDate = new Date(endTime);
    
    // Сохраняем время окончания в localStorage
    localStorage.setItem('contractTimerEnd', endTime.toString());
    
    // Показываем дату и время завершения
    const dateEl = el('ct_completion_date');
    const timeEl = el('ct_completion_time');
    
    if(dateEl && timeEl){
      // Форматируем дату
      const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit' 
      };
      
      dateEl.innerText = completionDate.toLocaleDateString('ru-RU', dateOptions);
      timeEl.innerText = completionDate.toLocaleTimeString('ru-RU', timeOptions);
    }
    
    // Обновляем текст статуса
    el('ct_time_remaining').innerText = 'через 24 часа';
    
    console.log('Дата завершения анализа установлена:', completionDate.toLocaleString());
  }

  // Функция показа даты завершения анализа для załącznik
  function showZałącznikCompletionDate(){
    // Устанавливаем время окончания: текущее время + 24 часа
    const endTime = new Date().getTime() + (24 * 60 * 60 * 1000);
    const completionDate = new Date(endTime);
    
    // Сохраняем время окончания в localStorage
    localStorage.setItem('załącznikTimerEnd', endTime.toString());
    
    // Показываем дату и время завершения
    const dateEl = el('załącznik_completion_date');
    const timeEl = el('załącznik_completion_time');
    
    if(dateEl && timeEl){
      // Форматируем дату
      const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit' 
      };
      
      dateEl.innerText = completionDate.toLocaleDateString('ru-RU', dateOptions);
      timeEl.innerText = completionDate.toLocaleTimeString('ru-RU', timeOptions);
    }
    
    // Обновляем текст статуса
    el('załącznik_time_remaining').innerText = 'через 24 часа';
    
    console.log('Дата завершения анализа załącznik установлена:', completionDate.toLocaleString());
  }

  async function załącznikStart(){
    if(!załącznik.file){ alert('Выберите файл.'); return; }
    
    // Анимация перехода между экранами
    const step1 = el('załącznik_step1');
    const step2 = el('załącznik_step2');
    
    step1.style.opacity = '0';
    step1.style.transform = 'translateX(-20px)';
    step1.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step1.style.display='none';
      step2.style.display='';
      step2.style.opacity = '0';
      step2.style.transform = 'translateX(20px)';
      step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step2.style.opacity = '1';
        step2.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
    
    el('załącznik_step3').style.display='none';
    el('załącznik_step4').style.display='none';
    el('załącznik_poll_note').innerText = '';
    
    // Показываем дату завершения анализа если нет backend
    if(!ENDPOINTS){
      showZałącznikCompletionDate();
    }

    try{
      // 1) загрузка файла
      let uploadRes = null;
      if(ENDPOINTS){
        const fd = new FormData();
        fd.append('file', załącznik.file);
        fd.append('source', 'emigrant_webapp');
        const resp = await fetch(ENDPOINTS.upload, { method:'POST', body: fd });
        if(!resp.ok) throw new Error('Upload failed');
        uploadRes = await resp.json(); // ожидаем {file_id, file_url, name, size}
      } else {
        // fallback: шлём боту метаданные, пусть он продолжит в чате
        uploadRes = { file_id: null, file_url: null, name: załącznik.file.name, size: załącznik.file.size };
      }

      załącznik.fileMeta = uploadRes;

      // 2) запуск анализа
      let analyzeRes = null;
      if(ENDPOINTS){
        const body = { file_id: uploadRes.file_id, file_url: uploadRes.file_url, prompt: AI_PROMPT, priority: załącznik.boosted?'high':'normal' };
        const resp = await fetch(ENDPOINTS.analyze, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!resp.ok) throw new Error('Analyze start failed');
        analyzeRes = await resp.json(); // ожидаем {job_id}
        załącznik.jobId = analyzeRes.job_id;
        startZałącznikPolling();
    } else {
        // отправляем в бота, который читает web_app_data
        try{
          tg && tg.sendData && tg.sendData(JSON.stringify({
            type:'analyze_załącznik',
            prompt: AI_PROMPT,
            fileMeta: { name: załącznik.file.name, size: załącznik.file.size },
            note:'Нет подключенного backend ENDPOINTS — передано в бота через sendData'
          }));
          // НЕ запускаем fakeFinishOk() сразу - ждем таймер на 24 часа
        }catch(e){}
      }

    }catch(err){
      console.error(err);
      el('załącznik_queue_msg').innerText = 'Не удалось запустить анализ. Попробуйте ещё раз.';
      el('załącznik_btn_boost').disabled = true;
    }
  }



  function ctBoost(){
    // Показываем экран оплаты с анимацией
    const step2 = el('ct_step2');
    const step3 = el('ct_step3');
    
    step2.style.opacity = '0';
    step2.style.transform = 'translateX(-20px)';
    step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step2.style.display='none';
      step3.style.display='';
      step3.style.opacity = '0';
      step3.style.transform = 'translateX(20px)';
      step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step3.style.opacity = '1';
        step3.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }

  function załącznikBoost(){
    // Показываем экран оплаты с анимацией
    const step2 = el('załącznik_step2');
    const step3 = el('załącznik_step3');
    
    step2.style.opacity = '0';
    step2.style.transform = 'translateX(-20px)';
    step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step2.style.display='none';
      step3.style.display='';
      step3.style.opacity = '0';
      step3.style.transform = 'translateX(20px)';
      step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step3.style.opacity = '1';
        step3.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }
  
  // Функция возврата к таймеру
  function ctBackToTimer(){
    const step3 = el('ct_step3');
    const step2 = el('ct_step2');
    
    step3.style.opacity = '0';
    step3.style.transform = 'translateX(20px)';
    step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step3.style.display='none';
      step2.style.display='';
      step2.style.opacity = '0';
      step2.style.transform = 'translateX(-20px)';
      step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step2.style.opacity = '1';
        step2.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }

  function załącznikBackToTimer(){
    const step3 = el('załącznik_step3');
    const step2 = el('załącznik_step2');
    
    step3.style.opacity = '0';
    step3.style.transform = 'translateX(20px)';
    step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    
    setTimeout(() => {
      step3.style.display='none';
      step2.style.display='';
      step2.style.opacity = '0';
      step2.style.transform = 'translateX(-20px)';
      step2.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step2.style.opacity = '1';
        step2.style.transform = 'translateX(0)';
      }, 10);
    }, 300);
  }
  
  // Функция обработки оплаты
  function ctProcessPayment(){
    // Имитируем процесс оплаты
    el('ct_poll_note').innerText = 'Обрабатываем оплаты...';
    
    setTimeout(() => {
      // После успешной оплаты сразу показываем результат
    ct.boosted = true;
      

      
      // Показываем экран загрузки с анимацией
      const step3 = el('ct_step3');
      const step4 = el('ct_step4');
      
      step3.style.opacity = '0';
      step3.style.transform = 'translateX(-20px)';
      step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step3.style.display='none';
        step4.style.display='';
        step4.style.opacity = '0';
        step4.style.transform = 'translateX(20px)';
        step4.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        setTimeout(() => {
          step4.style.opacity = '1';
          step4.style.transform = 'translateX(0)';
        }, 10);
      }, 300);
      
      // Имитируем загрузку результата
      el('ct_result_title').innerText = 'Обрабатываем результат...';
      el('ct_result_box').innerHTML = '<div class="spinner"></div><div style="margin-top:10px">AI анализирует документ...</div>';
      
      // Через 3 секунды показываем результат
      setTimeout(() => {
        // Генерируем случайный результат (подходит/не подходит)
        const isDocumentOk = Math.random() > 0.3; // 70% вероятность что документ подходит
        
        if(isDocumentOk){
          // Документ подходит - показываем экран успеха
          showSuccessResult();
        } else {
          // Документ не подходит - показываем экран с красными флагами
          showRedFlagsResult();
        }
      }, 3000);
      
    }, 2000);
  }
  
  function załącznikProcessPayment(){
    // Имитируем процесс оплаты
    el('załącznik_poll_note').innerText = 'Обрабатываем оплату...';
    
    setTimeout(() => {
      // После успешной оплаты сразу показываем результат
      załącznik.boosted = true;
      
      // Показываем экран загрузки с анимацией
      const step3 = el('załącznik_step3');
      const step4 = el('załącznik_step4');
      
      step3.style.opacity = '0';
      step3.style.transform = 'translateX(-20px)';
      step3.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      
      setTimeout(() => {
        step3.style.display='none';
        step4.style.display='';
        step4.style.opacity = '0';
        step4.style.transform = 'translateX(20px)';
        step4.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        setTimeout(() => {
          step4.style.opacity = '1';
          step4.style.transform = 'translateX(0)';
        }, 10);
      }, 300);
      
      // Имитируем загрузку результата
      el('załącznik_result_title').innerText = 'Обрабатываем результат...';
      el('załącznik_result_box').innerHTML = '<div class="spinner"></div><div style="margin-top:10px">AI анализирует документ...</div>';
      
      // Через 3 секунды показываем результат
      setTimeout(() => {
        // Генерируем случайный результат (подходит/не подходит)
        const isDocumentOk = Math.random() > 0.3; // 70% вероятность что документ подходит
        
        if(isDocumentOk){
          // Документ подходит - показываем экран успеха
          showZałącznikSuccessResult();
        } else {
          // Документ не подходит - показываем экран с красными флагами
          showZałącznikRedFlagsResult();
        }
      }, 3000);
      
    }, 2000);
  }
  
  // Функция показа успешного результата
  function showSuccessResult(){
    el('ct_result_title').innerText = 'Ура! Всё удалось 🎉';
    el('ct_result_box').className = 'status ok';
    el('ct_result_box').innerHTML = '<div>Все чётко. Замечаний нет.</div>';
    
    // Помечаем задачу как выполненную
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    localStorage.setItem('contractCheckedAt', String(Date.now()));
    // Мгновенно обновляем чеклист, если он открыт
    try { renderChecklist(); } catch(e) {}
  }
  
  function showZałącznikSuccessResult(){
    el('załącznik_result_title').innerText = 'Ура! Всё удалось 🎉';
    el('załącznik_result_box').className = 'status ok';
    el('załącznik_result_box').innerHTML = '<div>Все чётко. Замечаний нет.</div>';
    
    // Помечаем задачу как выполненную
    st.tasks = st.tasks.map(t=> t.id==='załącznik' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    localStorage.setItem('załącznikCheckedAt', String(Date.now()));
    // Мгновенно обновляем чеклист, если он открыт
    try { renderChecklist(); } catch(e) {}
  }
  
  // Функция показа результата с красными флагами
  function showRedFlagsResult(){
    el('ct_result_title').innerText = 'Мы заметили красные флаги в твоей умове';
    el('ct_result_box').className = 'status err';
    el('ct_result_box').innerHTML = `
      <div style="text-align:center;margin-bottom:16px">
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:24px;margin-bottom:8px">⚠️</div>
        <div>Узнай детальный отчет или проигнорируй наши подсказки</div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showDetailedReport()" style="width:100%;margin-bottom:8px">
          Узнать что не так
        </button>
        <button class="ghost" onclick="ignoreRedFlags()" style="width:100%;margin-bottom:8px">
          Проигнорировать
        </button>
        <button class="ghost" onclick="ctStartOver()" style="width:100%">
          Загрузить другой документ
        </button>
      </div>
    `;
    
    // Помечаем задачу как требующую внимания
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'inreview'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    // Обновляем чеклист
    try { renderChecklist(); } catch(e) {}
  }
  
  function showZałącznikRedFlagsResult(){
    el('załącznik_result_title').innerText = 'Мы заметили красные флаги в твоем załącznik';
    el('załącznik_result_box').className = 'status err';
    el('załącznik_result_box').innerHTML = `
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:24px;margin-bottom:8px">⚠️</div>
        <div>Узнай детальный отчет или проигнорируй наши подсказки</div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showZałącznikDetailedReport()" style="width:100%;margin-bottom:8px">
          Узнать что не так
        </button>
        <button class="ghost" onclick="ignoreZałącznikRedFlags()" style="width:100%;margin-bottom:8px">
          Проигнорировать
        </button>
        <button class="ghost" onclick="załącznikStartOver()" style="width:100%">
          Загрузить другой документ
        </button>
      </div>
    `;
    
    // Помечаем задачу как требующую внимания
    st.tasks = st.tasks.map(t=> t.id==='załącznik' ? {...t, status:'inreview'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    // Обновляем чеклист
    try { renderChecklist(); } catch(e) {}
  }
  
  // Функция показа детального отчета
  function showDetailedReport(){
    el('ct_result_box').innerHTML = `
      <div style="margin-bottom:16px">
        <h4>Детальный отчет по документу:</h4>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>Проблема 1:</strong> Неполная информация о работодателе
        </div>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>Проблема 2:</strong> Отсутствует указание на полную занятость
        </div>
        <div style="margin:8px 0;padding:8px;background:#0c0f14;border-radius:6px">
          <strong>Проблема 3:</strong> Не указан точный адрес рабочего места
        </div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showRedFlagsResult()" style="width:100%">
          Назад к результату
        </button>
      </div>
    `;
  }
  
  // Функция игнорирования красных флагов
  function ignoreRedFlags(){
    el('ct_result_box').innerHTML = `
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:24px;margin-bottom:8px">🤷</div>
        <div>Вы решили проигнорировать наши рекомендации</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">
          Задача отмечена как выполненная, но мы рекомендуем исправить найденные проблемы
        </div>
      </div>
      <div style="text-align:center">
        <button class="primary" onclick="showRedFlagsResult()" style="width:100%">
          Вернуться к результату
        </button>
      </div>
    `;
    
    // Помечаем задачу как выполненную (несмотря на проблемы)
    st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
    localStorage.setItem('tasks', JSON.stringify(st.tasks));
    // Обновляем чеклист
    try { renderChecklist(); } catch(e) {}
  }

  function startPolling(){
    if(!ct.jobId){ return; }
    if(ct.pollTimer){ clearInterval(ct.pollTimer); }
    ct.pollTimer = setInterval(async ()=>{
      try{
        const url = ENDPOINTS.status + '?id=' + encodeURIComponent(ct.jobId);
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('status failed');
        const data = await resp.json(); // ожидаем {status:'queued|running|succeeded|failed', result?:{ok:boolean, issues?:[] , message?:string}}
        if(data.status==='queued' || data.status==='running'){
          el('ct_poll_note').innerText = data.status==='running' ? 'AI анализирует документ…' : 'В очереди…';
          return;
        }
        clearInterval(ct.pollTimer); ct.pollTimer=null;
        showResultScreen(data);
      }catch(e){
        console.error(e);
        clearInterval(ct.pollTimer); ct.pollTimer=null;
        showResultScreen({status:'failed', result:{ ok:false, message:'Ошибка получения статуса.' }});
      }
    }, 2500);
  }

  function showResultScreen(data){
    el('ct_step2').style.display='none';
    el('ct_step4').style.display='';
    const ok = data.status==='succeeded' && data.result?.ok!==false;
    el('ct_result_title').innerText = ok ? 'Ура! Всё удалось 🎉' : 'Найдены замечания';
    el('ct_result_box').className = 'status ' + (ok?'ok':'err');

    if(ok){
      el('ct_result_text').innerText = data.result?.message || 'Все чётко. Замечаний нет.';
      // можно пометить задачу как "inreview" или "done"
      st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'done'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
      try { renderChecklist(); } catch(e) {}
    }else{
      const issues = data.result?.issues || [];
      const text = (data.result?.message || 'Обрати внимание на следующие пункты:') + '\n' +
        (issues.length? issues.map((x,i)=>`${i+1}) ${x}`).join('\n') : '');
      el('ct_result_text').innerText = text.trim();
      st.tasks = st.tasks.map(t=> t.id==='contract' ? {...t, status:'inreview'} : t);
      localStorage.setItem('tasks', JSON.stringify(st.tasks));
      try { renderChecklist(); } catch(e) {}
    }
  }

  // имитация завершения без backend
  function fakeFinishOk(){
    setTimeout(()=>{
      // Генерируем случайный результат (подходит/не подходит)
      const isDocumentOk = Math.random() > 0.3; // 70% вероятность что документ подходит
      
      if(isDocumentOk){
        // Документ подходит - показываем экран успеха
        showSuccessResult();
      } else {
        // Документ не подходит - показываем экран с красными флагами
        showRedFlagsResult();
      }
    }, 2000);
  }

  // ====== Модалка — открытие и доступность кнопки
  function closeOnBackdrop(e){ if(e.target.id==='modal') closeModal(); }
  document.getElementById('modal').addEventListener('click', closeOnBackdrop);
  
  function closeZałącznikOnBackdrop(e){ if(e.target.id==='załącznik_modal') closeZałącznikModal(); }
  document.getElementById('załącznik_modal').addEventListener('click', closeZałącznikOnBackdrop);
  
  document.getElementById('ct_btn_upload').disabled = true; // init
  document.getElementById('załącznik_btn_upload').disabled = true; // init

  // ====== Автозагрузка
  (function init(){
    if(st.track){
      document.getElementById('onb').style.display='none';
      document.getElementById('home').style.display='';
      renderChecklist();
      
      // Проверяем, есть ли активная дата завершения анализа
      const contractTimerEnd = localStorage.getItem('contractTimerEnd');
      if(contractTimerEnd){
        const endTime = parseInt(contractTimerEnd);
        const now = new Date().getTime();
        if(endTime > now){
          // Дата еще актуальна - показываем её
          const completionDate = new Date(endTime);
          const dateEl = el('ct_completion_date');
          const timeEl = el('ct_completion_time');
          
          if(dateEl && timeEl){
            const dateOptions = { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            };
            const timeOptions = { 
              hour: '2-digit', 
              minute: '2-digit' 
            };
            
            dateEl.innerText = completionDate.toLocaleDateString('ru-RU', dateOptions);
            timeEl.innerText = completionDate.toLocaleTimeString('ru-RU', timeOptions);
          }
        } else {
          // Дата истекла - очищаем
          localStorage.removeItem('contractTimerEnd');
        }
      }

      // Проверяем, есть ли активная дата завершения анализа для załącznik
      const załącznikTimerEnd = localStorage.getItem('załącznikTimerEnd');
      if(załącznikTimerEnd){
        const endTime = parseInt(załącznikTimerEnd);
        const now = new Date().getTime();
        if(endTime > now){
          // Дата еще актуальна - показываем её
          const completionDate = new Date(endTime);
          const dateEl = el('załącznik_completion_date');
          const timeEl = el('załącznik_completion_time');
          
          if(dateEl && timeEl){
            const dateOptions = { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            };
            const timeOptions = { 
              hour: '2-digit', 
              minute: '2-digit' 
            };
            
            dateEl.innerText = completionDate.toLocaleDateString('ru-RU', dateOptions);
            timeEl.innerText = completionDate.toLocaleTimeString('ru-RU', timeOptions);
          }
        } else {
          // Дата истекла - очищаем
          localStorage.removeItem('załącznikTimerEnd');
        }
      }
    } else {
      showQ(1);
    }
  })();
</script>
</body>
</html>
